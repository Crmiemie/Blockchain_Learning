 <img src="/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-08-31 09.48.04.png" alt="截屏2023-08-31 09.48.04" style="zoom:60%;" />

| **报告名称**：   | 实验六：*Hyperledger Fabric 2.4* 单机容器部署多*3-Orderer-4Org-2Peer-4User*网络 |
| ---------------- | ------------------------------------------------------------ |
| **学生姓名：**   | 杨超然                                                       |
| **学生学号：**   | 202106060220                                                 |
| **专业班级：**   | 信管2101班                                                   |
| **学**  **院：** | 工商管理学院                                                 |
| **指导老师：**   | 周中定                                                       |
| **日  期：**     | 2023.10.                                                     |

------

[TOC]



------

本实验主要实现搭建一个3 *ordere*r节点、4个*org*组织，其中每个组织各2个*peer*节点的*fabric* 2.4.6网络，共识集群采用的3-*etcd raft*协议，4个用户（Users）节点

# 一、相关环境的安装与准备

这里的环境主要包括以下内容：

> - *go*
> - *git*
> - *docker*
> - *docker-compose*
> - *jq*
> - *fabric、fabric-ca*以及fabric-sample相关docker镜像和相关二进制文件
>   详情可以参考另一篇文章：fabric基础网络环境准备与搭建。

注：下面的操作都是基于上面文章里面的软件版本来进行操作，请尽量确保版本一致，否则可能会出现不一样的错误。

| 节点       | 宿主机 IP      | hosts                  | 端口                       |
| ---------- | -------------- | ---------------------- | -------------------------- |
| orderer0   | 192.168.31.188 | orderer0.example.com   | 7050 , 8443 , 9443         |
| orderer1   | 192.168.31.188 | orderer1.example.com   | 8050 , 8444 ,9444          |
| orderer2   | 192.168.31.188 | orderer2.example.com   | 9050 , 8445 ，9445         |
| peer0.org1 | 192.168.31.188 | peer0.org1.example.com | 7051 , 7052 , 9446 , 8125  |
| peer1.org1 | 192.168.31.188 | peer1.org1.example.com | 8051 , 7053 , 9447 , 8126  |
| peer0.org2 | 192.168.31.188 | peer0.org2.example.com | 9051 , 7054 , 9448 , 8127  |
| peer1.org2 | 192.168.31.188 | peer1.org2.example.com | 10051 , 7055 , 9449 , 8128 |
| peer0.org3 | 192.168.31.188 | peer0.org3.example.com |                            |
| peer1.org3 | 192.168.31.188 | peer0.org3.example.com |                            |
| peer0.org4 | 192.168.31.188 | peer0.org4.example.com |                            |
| peer1.org4 | 192.168.31.188 | peer1.org4.example.com |                            |
| cli1.org1  | 192.168.31.188 | User1@org1.example.com |                            |
| cli2.org2  | 192.168.31.188 | User1@org2.example.com |                            |
| cli3.org3  | 192.168.31.188 | User1@org3.example.com |                            |
| cli4.org4  | 192.168.31.188 | User1@org4.example.com |                            |
| Admin.org1 | 192.168.31.188 | Admin@org1.example.com |                            |
| Admin.org2 | 192.168.31.188 | Admin@org2.example.com |                            |
| Admin.org3 | 192.168.31.188 | Admin@org3.example.com |                            |
| Admin.org4 | 192.168.31.188 | Admin@org4.example.com |                            |

# 二、生成相关的证书材料

## 1.建立项目目录

```sh
$ mkdir raft-test  
$ cd raft-test
```

![截屏2023-10-16 21.26.01](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 21.26.01.png)

## 2.编写配置文件

生成组织证书配置模板

```bash
$ cryptogen showtemplate > crypto-config.yaml
```

![截屏2023-10-16 21.26.53](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 21.26.53.png)

在*raft-test*目录下，新建*crypto-config.yaml*文件。文件内容如下面所示。

*crypto-config.yaml*文件内容

```yaml
# ---------------------------------------------------------------------------
# "OrdererOrgs" - Definition of organizations managing orderer nodes
# ---------------------------------------------------------------------------
OrdererOrgs:
  # ---------------------------------------------------------------------------
  # Orderer
  # ---------------------------------------------------------------------------
  - Name: Orderer
    Domain: example.com
    EnableNodeOUs: true

    # ---------------------------------------------------------------------------
    # "Specs" - See PeerOrgs below for complete description
    # ---------------------------------------------------------------------------
    Specs:
      - Hostname: orderer0
      - Hostname: orderer1
      - Hostname: orderer2

# ---------------------------------------------------------------------------
# "PeerOrgs" - Definition of organizations managing peer nodes
# ---------------------------------------------------------------------------
PeerOrgs:
  # ---------------------------------------------------------------------------
  # Org1
  # ---------------------------------------------------------------------------
  - Name: Org1
    Domain: org1.supervisor.com
    EnableNodeOUs: true

    # ---------------------------------------------------------------------------
    # "CA"
    # ---------------------------------------------------------------------------
    # Uncomment this section to enable the explicit definition of the CA for this
    # organization.  This entry is a Spec.  See "Specs" section below for details.
    # ---------------------------------------------------------------------------
    # CA:
    #    Hostname: ca # implicitly ca.org1.example.com
    #    Country: US
    #    Province: California
    #    Locality: San Francisco
    #    OrganizationalUnit: Hyperledger Fabric
    #    StreetAddress: address for org # default nil
    #    PostalCode: postalCode for org # default nil

    # ---------------------------------------------------------------------------
    # "Specs"
    # ---------------------------------------------------------------------------
    # Uncomment this section to enable the explicit definition of hosts in your
    # configuration.  Most users will want to use Template, below
    #
    # Specs is an array of Spec entries.  Each Spec entry consists of two fields:
    #   - Hostname:   (Required) The desired hostname, sans the domain.
    #   - CommonName: (Optional) Specifies the template or explicit override for
    #                 the CN.  By default, this is the template:
    #
    #                              "{{.Hostname}}.{{.Domain}}"
    #
    #                 which obtains its values from the Spec.Hostname and
    #                 Org.Domain, respectively.
    #   - SANS:       (Optional) Specifies one or more Subject Alternative Names
    #                 to be set in the resulting x509. Accepts template
    #                 variables {{.Hostname}}, {{.Domain}}, {{.CommonName}}. IP
    #                 addresses provided here will be properly recognized. Other
    #                 values will be taken as DNS names.
    #                 NOTE: Two implicit entries are created for you:
    #                     - {{ .CommonName }}
    #                     - {{ .Hostname }}
    # ---------------------------------------------------------------------------
    # Specs:
    #   - Hostname: foo # implicitly "foo.org1.example.com"
    #     CommonName: foo27.org5.example.com # overrides Hostname-based FQDN set above
    #     SANS:
    #       - "bar.{{.Domain}}"
    #       - "altfoo.{{.Domain}}"
    #       - "{{.Hostname}}.org6.net"
    #       - 172.16.10.31
    #   - Hostname: bar
    #   - Hostname: baz

    # ---------------------------------------------------------------------------
    # "Template"
    # ---------------------------------------------------------------------------
    # Allows for the definition of 1 or more hosts that are created sequentially
    # from a template. By default, this looks like "peer%d" from 0 to Count-1.
    # You may override the number of nodes (Count), the starting index (Start)
    # or the template used to construct the name (Hostname).
    #
    # Note: Template and Specs are not mutually exclusive.  You may define both
    # sections and the aggregate nodes will be created for you.  Take care with
    # name collisions
    # ---------------------------------------------------------------------------
    Template:
      Count: 2
      # Start: 5
      # Hostname: {{.Prefix}}{{.Index}} # default
      # SANS:
      #   - "{{.Hostname}}.alt.{{.Domain}}"

    # ---------------------------------------------------------------------------
    # "Users"
    # ---------------------------------------------------------------------------
    # Count: The number of user accounts _in addition_ to Admin
    # ---------------------------------------------------------------------------
    Users:
      Count: 1

  # ---------------------------------------------------------------------------
  # Org2: See "Org1" for full specification
  # ---------------------------------------------------------------------------
  - Name: Org2
    Domain: org2.build.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1

  - Name: Org3
    Domain: org3.supplier.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1

  - Name: Org4
    Domain: org4.logistics.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1
```

![截屏2023-10-16 22.19.21](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 22.19.21.png)

![截屏2023-10-16 22.42.23](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 22.42.23.png)

*Name*和*Domain*就是关于这个组织的名字和域名，这主要是用于生成证书的时候，证书内会包含该信息。而Template Count=2是说要生成2套公私钥和证书，一套是*peer0.org2*的，还有一套是*peer1.org2*的。最后*Users.* Count=1是说每个Template下面会有几个普通User（注意，*Admin*是*Admin*，不包含在这个计数中），这里配置了1，也就是说我们只需要一个普通用户[User1@org2.example.com](mailto:User1@org2.example.com) 我们可以根据实际需要调整这个配置文件，增删*Org Users*等。

## 3.生成组织证书

根据配置文件crypto-config.yaml来生成证书，请确保已经将生成的fabric二进制命令所在的bin目录加到环境变量，否则无法执行下面的命令。执行完后生成的证书放在了./crypto-config/

```bash
$ cryptogen generate --config=crypto-config.yaml

#或
$ cryptogen generate --config=crypto-config.yaml --output=organizations
    
org1.supervisor.com
org2.build.com
org3.supplier.com
org4.logistics.com

$ ll

drwxr-xr-x. 4 root root 4096 5月   5 19:24 crypto-config
-rw-r--r--. 1 root root 5760 5月   5 19:23 crypto-config.yaml
```

![截屏2023-10-16 22.59.26](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 22.59.26.png)

![截屏2023-10-19 22.16.11](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-19 22.16.11.png)

# 三、生成相关的通道配置文件

## 1.编辑配置文件

在*raft-test*目录下，新建*configtx.yaml*文件。文件内容如下面所示。

> *configtx.yaml文件内容*

```yaml
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

---
################################################################################
#
#   Section: Organizations
#
#   - This section defines the different organizational identities which will
#   be referenced later in the configuration.
#
################################################################################
Organizations:

    # SampleOrg defines an MSP using the sampleconfig.  It should never be used
    # in production but may be used as a template for other definitions
    - &OrdererOrg
        # DefaultOrg defines the organization which is used in the sampleconfig
        # of the fabric.git development environment
        Name: OrdererOrg

        # ID to load the MSP definition as
        ID: OrdererMSP

        # MSPDir is the filesystem path which contains the MSP configuration
        MSPDir: crypto-config/ordererOrganizations/example.com/msp

        # Policies defines the set of policies at this level of the config tree
        # For organization policies, their canonical path is usually
        #   /Channel/<Application|Orderer>/<OrgName>/<PolicyName>
        Policies:
            Readers:
                Type: Signature
                Rule: "OR('OrdererMSP.member')"
            Writers:
                Type: Signature
                Rule: "OR('OrdererMSP.member')"
            Admins:
                Type: Signature
                Rule: "OR('OrdererMSP.admin')"

    - &Org1
        # DefaultOrg defines the organization which is used in the sampleconfig
        # of the fabric.git development environment
        Name: Org1

        # ID to load the MSP definition as
        ID: Org1MSP

        MSPDir: crypto-config/peerOrganizations/org1.supervisor.com/msp

        # Policies defines the set of policies at this level of the config tree
        # For organization policies, their canonical path is usually
        #   /Channel/<Application|Orderer>/<OrgName>/<PolicyName>
        Policies:
            Readers:
                Type: Signature
                Rule: "OR('Org1MSP.admin', 'Org1MSP.peer', 'Org1MSP.client')"
            Writers:
                Type: Signature
                Rule: "OR('Org1MSP.admin', 'Org1MSP.client')"
            Admins:
                Type: Signature
                Rule: "OR('Org1MSP.admin')"
            Endorsement:
                Type: Signature
                Rule: "OR('Org1MSP.peer')"

        # leave this flag set to true.
        AnchorPeers:
            # AnchorPeers defines the location of peers which can be used
            # for cross org gossip communication.  Note, this value is only
            # encoded in the genesis block in the Application section context
            - Host: peer0.org1.supervisor.com
              Port: 7051

    - &Org2
        # DefaultOrg defines the organization which is used in the sampleconfig
        # of the fabric.git development environment
        Name: Org2

        # ID to load the MSP definition as
        ID: Org2MSP

        MSPDir: crypto-config/peerOrganizations/org2.build.com/msp

        # Policies defines the set of policies at this level of the config tree
        # For organization policies, their canonical path is usually
        #   /Channel/<Application|Orderer>/<OrgName>/<PolicyName>
        Policies:
            Readers:
                Type: Signature
                Rule: "OR('Org2MSP.admin', 'Org2MSP.peer', 'Org2MSP.client')"
            Writers:
                Type: Signature
                Rule: "OR('Org2MSP.admin', 'Org2MSP.client')"
            Admins:
                Type: Signature
                Rule: "OR('Org2MSP.admin')"
            Endorsement:
                Type: Signature
                Rule: "OR('Org2MSP.peer')"

        AnchorPeers:
            # AnchorPeers defines the location of peers which can be used
            # for cross org gossip communication.  Note, this value is only
            # encoded in the genesis block in the Application section context
            - Host: peer0.org2.build.com
              Port: 9051

    - &Org3
        # DefaultOrg defines the organization which is used in the sampleconfig
        # of the fabric.git development environment
        Name: Org3

        # ID to load the MSP definition as
        ID: Org3MSP

        MSPDir: crypto-config/peerOrganizations/org3.supplier.com/msp

        # Policies defines the set of policies at this level of the config tree
        # For organization policies, their canonical path is usually
        #   /Channel/<Application|Orderer>/<OrgName>/<PolicyName>
        Policies:
            Readers:
                Type: Signature
                Rule: "OR('Org3MSP.admin', 'Org3MSP.peer', 'Org3MSP.client')"
            Writers:
                Type: Signature
                Rule: "OR('Org3MSP.admin', 'Org3MSP.client')"
            Admins:
                Type: Signature
                Rule: "OR('Org3MSP.admin')"
            Endorsement:
                Type: Signature
                Rule: "OR('Org3MSP.peer')"

        AnchorPeers:
            # AnchorPeers defines the location of peers which can be used
            # for cross org gossip communication.  Note, this value is only
            # encoded in the genesis block in the Application section context
            - Host: peer0.org3.supplier.com
              Port: 11051

    - &Org4
        # DefaultOrg defines the organization which is used in the sampleconfig
        # of the fabric.git development environment
        Name: Org4

        # ID to load the MSP definition as
        ID: Org4MSP

        MSPDir: crypto-config/peerOrganizations/org4.logistics.com/msp

        # Policies defines the set of policies at this level of the config tree
        # For organization policies, their canonical path is usually
        #   /Channel/<Application|Orderer>/<OrgName>/<PolicyName>
        Policies:
            Readers:
                Type: Signature
                Rule: "OR('Org4MSP.admin', 'Org4MSP.peer', 'Org4MSP.client')"
            Writers:
                Type: Signature
                Rule: "OR('Org4MSP.admin', 'Org4MSP.client')"
            Admins:
                Type: Signature
                Rule: "OR('Org4MSP.admin')"
            Endorsement:
                Type: Signature
                Rule: "OR('Org4MSP.peer')"

        AnchorPeers:
            # AnchorPeers defines the location of peers which can be used
            # for cross org gossip communication.  Note, this value is only
            # encoded in the genesis block in the Application section context
            - Host: peer0.org4.logistics.com
              Port: 13051

################################################################################
#
#   SECTION: Capabilities
#
#   - This section defines the capabilities of fabric network. This is a new
#   concept as of v1.1.0 and should not be utilized in mixed networks with
#   v1.0.x peers and orderers.  Capabilities define features which must be
#   present in a fabric binary for that binary to safely participate in the
#   fabric network.  For instance, if a new MSP type is added, newer binaries
#   might recognize and validate the signatures from this type, while older
#   binaries without this support would be unable to validate those
#   transactions.  This could lead to different versions of the fabric binaries
#   having different world states.  Instead, defining a capability for a channel
#   informs those binaries without this capability that they must cease
#   processing transactions until they have been upgraded.  For v1.0.x if any
#   capabilities are defined (including a map with all capabilities turned off)
#   then the v1.0.x peer will deliberately crash.
#
################################################################################
Capabilities:
    # Channel capabilities apply to both the orderers and the peers and must be
    # supported by both.
    # Set the value of the capability to true to require it.
    Channel: &ChannelCapabilities
        # V2_0 capability ensures that orderers and peers behave according
        # to v2.0 channel capabilities. Orderers and peers from
        # prior releases would behave in an incompatible way, and are therefore
        # not able to participate in channels at v2.0 capability.
        # Prior to enabling V2.0 channel capabilities, ensure that all
        # orderers and peers on a channel are at v2.0.0 or later.
        V2_0: true

    # Orderer capabilities apply only to the orderers, and may be safely
    # used with prior release peers.
    # Set the value of the capability to true to require it.
    Orderer: &OrdererCapabilities
        # V2_0 orderer capability ensures that orderers behave according
        # to v2.0 orderer capabilities. Orderers from
        # prior releases would behave in an incompatible way, and are therefore
        # not able to participate in channels at v2.0 orderer capability.
        # Prior to enabling V2.0 orderer capabilities, ensure that all
        # orderers on channel are at v2.0.0 or later.
        V2_0: true

    # Application capabilities apply only to the peer network, and may be safely
    # used with prior release orderers.
    # Set the value of the capability to true to require it.
    Application: &ApplicationCapabilities
        # V2_0 application capability ensures that peers behave according
        # to v2.0 application capabilities. Peers from
        # prior releases would behave in an incompatible way, and are therefore
        # not able to participate in channels at v2.0 application capability.
        # Prior to enabling V2.0 application capabilities, ensure that all
        # peers on channel are at v2.0.0 or later.
        V2_0: true

################################################################################
#
#   SECTION: Application
#
#   - This section defines the values to encode into a config transaction or
#   genesis block for application related parameters
#
################################################################################
Application: &ApplicationDefaults

    # Organizations is the list of orgs which are defined as participants on
    # the application side of the network
    Organizations:

    # Policies defines the set of policies at this level of the config tree
    # For Application policies, their canonical path is
    #   /Channel/Application/<PolicyName>
    Policies:
        Readers:
            Type: ImplicitMeta
            Rule: "ANY Readers"
        Writers:
            Type: ImplicitMeta
            Rule: "ANY Writers"
        Admins:
            Type: ImplicitMeta
            Rule: "MAJORITY Admins"
        LifecycleEndorsement:
            Type: ImplicitMeta
            Rule: "MAJORITY Endorsement"
        Endorsement:
            Type: ImplicitMeta
            Rule: "MAJORITY Endorsement"

    Capabilities:
        <<: *ApplicationCapabilities
################################################################################
#
#   SECTION: Orderer
#
#   - This section defines the values to encode into a config transaction or
#   genesis block for orderer related parameters
#
################################################################################
Orderer: &OrdererDefaults

    # Orderer Type: The orderer implementation to start
    OrdererType: etcdraft
    
    # Addresses used to be the list of orderer addresses that clients and peers
    # could connect to.  However, this does not allow clients to associate orderer
    # addresses and orderer organizations which can be useful for things such
    # as TLS validation.  The preferred way to specify orderer addresses is now
    # to include the OrdererEndpoints item in your org definition
    Addresses:
        - orderer0.example.com:7050
        - orderer1.example.com:8050
        - orderer2.example.com:9050

    EtcdRaft:
        Consenters:
        - Host: orderer0.example.com
          Port: 7050
          ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt
          ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt

    # Batch Timeout: The amount of time to wait before creating a batch
    BatchTimeout: 2s

    # Batch Size: Controls the number of messages batched into a block
    BatchSize:

        # Max Message Count: The maximum number of messages to permit in a batch
        MaxMessageCount: 10

        # Absolute Max Bytes: The absolute maximum number of bytes allowed for
        # the serialized messages in a batch.
        AbsoluteMaxBytes: 99 MB

        # Preferred Max Bytes: The preferred maximum number of bytes allowed for
        # the serialized messages in a batch. A message larger than the preferred
        # max bytes will result in a batch larger than preferred max bytes.
        PreferredMaxBytes: 512 KB

    # Organizations is the list of orgs which are defined as participants on
    # the orderer side of the network
    Organizations:

    # Policies defines the set of policies at this level of the config tree
    # For Orderer policies, their canonical path is
    #   /Channel/Orderer/<PolicyName>
    Policies:
        Readers:
            Type: ImplicitMeta
            Rule: "ANY Readers"
        Writers:
            Type: ImplicitMeta
            Rule: "ANY Writers"
        Admins:
            Type: ImplicitMeta
            Rule: "MAJORITY Admins"
        # BlockValidation specifies what signatures must be included in the block
        # from the orderer for the peer to validate it.
        BlockValidation:
            Type: ImplicitMeta
            Rule: "ANY Writers"

################################################################################
#
#   CHANNEL
#
#   This section defines the values to encode into a config transaction or
#   genesis block for channel related parameters.
#
################################################################################
Channel: &ChannelDefaults
    # Policies defines the set of policies at this level of the config tree
    # For Channel policies, their canonical path is
    #   /Channel/<PolicyName>
    Policies:
        # Who may invoke the 'Deliver' API
        Readers:
            Type: ImplicitMeta
            Rule: "ANY Readers"
        # Who may invoke the 'Broadcast' API
        Writers:
            Type: ImplicitMeta
            Rule: "ANY Writers"
        # By default, who may modify elements at this config level
        Admins:
            Type: ImplicitMeta
            Rule: "MAJORITY Admins"

    # Capabilities describes the channel level capabilities, see the
    # dedicated Capabilities section elsewhere in this file for a full
    # description
    Capabilities:
        <<: *ChannelCapabilities

################################################################################
#
#   Profile
#
#   - Different configuration profiles may be encoded here to be specified
#   as parameters to the configtxgen tool
#
################################################################################
Profiles:

    FourOrgsOrdererGenesis:
        <<: *ChannelDefaults
        Orderer:
            <<: *OrdererDefaults
            OrdererType: etcdraft
            EtcdRaft:
                Consenters:
                - Host: orderer0.example.com
                  Port: 7050
                  ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/tls/server.crt
                  ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/tls/server.crt
                - Host: orderer1.example.com
                  Port: 8050
                  ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer1.example.com/tls/server.crt
                  ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer1.example.com/tls/server.crt
                - Host: orderer2.example.com
                  Port: 9050
                  ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt
                  ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt
            Addresses:
                - orderer0.example.com:7050
                - orderer1.example.com:8050
                - orderer2.example.com:9050
            Organizations:
                - *OrdererOrg
            Capabilities:
                <<: *OrdererCapabilities
        Consortiums:
            SampleConsortium:
                Organizations:
                    - *Org1
                    - *Org2
                    - *Org3
                    - *Org4

    FourOrgsChannel:
        Consortium: SampleConsortium
        <<: *ChannelDefaults
        Application:
            <<: *ApplicationDefaults
            Organizations:
                - *Org1
                - *Org2
                - *Org3
                - *Org4
            Capabilities:
                <<: *ApplicationCapabilities
```

![截屏2023-10-17 17.35.39](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-17 17.35.39.png)

## 2.生成创世区块文件

> 特别提醒：创世区块通道名称*channelID*采用*syschannel*

```sh
$ configtxgen -profile FourOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block -channelID syschannel
```

![截屏2023-10-17 17.43.05](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-17 17.43.05.png)

> 备注：创世通道*channelID* 采用*fabric-channel*名称，与下面通道名称不能相同，下面采用appchannel

## 3.生成通道文件

```sh
$ configtxgen -profile FourOrgsChannel -outputCreateChannelTx ./channel-artifacts/appchannel.tx -channelID appchannel
```

![截屏2023-10-17 17.43.43](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-17 17.43.43.png)

## 4.创建更新锚节点的配置更新

因为联盟有4个组织，所以本例中需要对每个组织分别调用一次

```sh
$ configtxgen -profile FourOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID appchannel -asOrg Org1

$ configtxgen -profile FourOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID appchannel -asOrg Org2

$ configtxgen -profile FourOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org3MSPanchors.tx -channelID appchannel -asOrg Org3

$ configtxgen -profile FourOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org4MSPanchors.tx -channelID appchannel -asOrg Org4
```

![截屏2023-10-17 17.45.29](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-17 17.45.29.png)

## 5.检查是否成功配置

```sh
$ ll channel-artifacts
```

![截屏2023-10-17 17.46.17](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-17 17.46.17.png)

# 四、编写docker-compose.yaml

## 1.*docker-compose.yaml* 文件配置

在*raft-test*目录下，新建*docker-compose.yaml*文件。文件内容如下面所示。

> *docker-compose.yaml*文件内容

```yaml
version: '3.7'

volumes:
  orderer0.example.com:
  orderer1.example.com:
  orderer2.example.com:
  peer0.org1.supervisor.com:
  peer1.org1.supervisor.com:
  peer0.org2.build.com:
  peer1.org2.build.com:
  peer0.org3.supplier.com:
  peer1.org3.supplier.com:
  peer0.org4.logistics.com:
  peer1.org4.logistics.com:

networks:
  test:
    name: ordersFabric_test

services:

  orderer0.example.com:
    container_name: orderer0.example.com
    image: hyperledger/fabric-orderer:latest
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_LISTENPORT=7050
      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp
      # enabled TLS
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      
      - ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_CLUSTER_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      
      - ORDERER_GENERAL_GENESISMETHOD=file
      - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block
      
      - ORDERER_CHANNELPARTICIPATION_ENABLED=true
      
      - ORDERER_ADMIN_TLS_ENABLED=true
      - ORDERER_ADMIN_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_ADMIN_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_ADMIN_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_TLS_CLIENTROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_LISTENADDRESS=0.0.0.0:7053
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric
    command: orderer
    volumes:
      - ./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block
      - ./crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp:/var/hyperledger/orderer/msp
      - ./crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/tls/:/var/hyperledger/orderer/tls
    ports:
      - 7050:7050
      - 7053:7053
    networks:
      - test

  orderer1.example.com:
    container_name: orderer1.example.com
    image: hyperledger/fabric-orderer:latest
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_LISTENPORT=8050
      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp
      # enabled TLS
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
     
      - ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_CLUSTER_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_GENERAL_GENESISMETHOD=file
      - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block
      - ORDERER_CHANNELPARTICIPATION_ENABLED=true
      - ORDERER_ADMIN_TLS_ENABLED=true
      - ORDERER_ADMIN_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_ADMIN_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_ADMIN_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_TLS_CLIENTROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_LISTENADDRESS=0.0.0.0:7053
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric
    command: orderer
    volumes:
      - ./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block
      - ./crypto-config/ordererOrganizations/example.com/orderers/orderer1.example.com/msp:/var/hyperledger/orderer/msp
      - ./crypto-config/ordererOrganizations/example.com/orderers/orderer1.example.com/tls/:/var/hyperledger/orderer/tls
    ports:
      - 8050:8050
      - 7054:7053
    networks:
      - test

  orderer2.example.com:
    container_name: orderer2.example.com
    image: hyperledger/fabric-orderer:latest
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_LISTENPORT=9050
      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp
      # enabled TLS
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
     
      - ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_CLUSTER_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_GENERAL_GENESISMETHOD=file
      - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block
      - ORDERER_CHANNELPARTICIPATION_ENABLED=true
      - ORDERER_ADMIN_TLS_ENABLED=true
      - ORDERER_ADMIN_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_ADMIN_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_ADMIN_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_TLS_CLIENTROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_LISTENADDRESS=0.0.0.0:7053
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric
    command: orderer
    volumes:
      - ./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block
      - ./crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/msp:/var/hyperledger/orderer/msp
      - ./crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/:/var/hyperledger/orderer/tls
    ports:
      - 9050:9050
      - 7055:7053
    networks:
      - test

  peer0.org1.supervisor.com:
    container_name: peer0.org1.supervisor.com
    image: hyperledger/fabric-peer:latest
    labels:
      service: hyperledger-fabric
    environment:
      #Generic peer variables
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=ordersFabric_test
      - FABRIC_LOGGING_SPEC=INFO
      #- FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Peer specific variabes
      - CORE_PEER_ID=peer0.org1.supervisor.com
      - CORE_PEER_ADDRESS=peer0.org1.supervisor.com:7051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:7051
      - CORE_PEER_CHAINCODEADDRESS=peer0.org1.supervisor.com:7052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org1.supervisor.com:8051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.supervisor.com:7051
      - CORE_PEER_LOCALMSPID=Org1MSP
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - ./crypto-config/peerOrganizations/org1.supervisor.com/peers/peer0.org1.supervisor.com/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/org1.supervisor.com/peers/peer0.org1.supervisor.com/tls:/etc/hyperledger/fabric/tls
      - /var/run/:/host/var/run/
      - ./:/etc/hyperledger/channel/
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    ports:
      - 7051:7051
    networks:
      - test

  peer1.org1.supervisor.com:
    container_name: peer1.org1.supervisor.com
    image: hyperledger/fabric-peer:latest
    labels:
      service: hyperledger-fabric
    environment:
      #Generic peer variables
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=ordersFabric_test
      - FABRIC_LOGGING_SPEC=INFO
      #- FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Peer specific variabes
      - CORE_PEER_ID=peer1.org1.supervisor.com
      - CORE_PEER_ADDRESS=peer1.org1.supervisor.com:8051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:8051
      - CORE_PEER_CHAINCODEADDRESS=peer1.org1.supervisor.com:8052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:8052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org1.supervisor.com:7051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.supervisor.com:8051
      - CORE_PEER_LOCALMSPID=Org1MSP
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - ./crypto-config/peerOrganizations/org1.supervisor.com/peers/peer1.org1.supervisor.com/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/org1.supervisor.com/peers/peer1.org1.supervisor.com/tls:/etc/hyperledger/fabric/tls
      - /var/run/:/host/var/run/
      - ./:/etc/hyperledger/channel/
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    ports:
      - 8051:8051
    networks:
      - test

  peer0.org2.build.com:
    container_name: peer0.org2.build.com
    image: hyperledger/fabric-peer:latest
    labels:
      service: hyperledger-fabric
    environment:
      #Generic peer variables
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=ordersFabric_test
      - FABRIC_LOGGING_SPEC=INFO
      #- FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Peer specific variabes
      - CORE_PEER_ID=peer0.org2.build.com
      - CORE_PEER_ADDRESS=peer0.org2.build.com:9051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:9051
      - CORE_PEER_CHAINCODEADDRESS=peer0.org2.build.com:9052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:9052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org2.build.com:10051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org2.build.com:9051
      - CORE_PEER_LOCALMSPID=Org2MSP
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - ./crypto-config/peerOrganizations/org2.build.com/peers/peer0.org2.build.com/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/org2.build.com/peers/peer0.org2.build.com/tls:/etc/hyperledger/fabric/tls
      - /var/run/:/host/var/run/
      - ./:/etc/hyperledger/channel/
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    ports:
      - 9051:9051
    networks:
      - test

  peer1.org2.build.com:
    container_name: peer1.org2.build.com
    image: hyperledger/fabric-peer:latest
    labels:
      service: hyperledger-fabric
    environment:
      #Generic peer variables
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=ordersFabric_test
      - FABRIC_LOGGING_SPEC=INFO
      #- FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Peer specific variabes
      - CORE_PEER_ID=peer1.org2.build.com
      - CORE_PEER_ADDRESS=peer1.org2.build.com:10051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:10051
      - CORE_PEER_CHAINCODEADDRESS=peer1.org2.build.com:10052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:10052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org2.build.com:9051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org2.build.com:10051
      - CORE_PEER_LOCALMSPID=Org2MSP
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - ./crypto-config/peerOrganizations/org2.build.com/peers/peer1.org2.build.com/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/org2.build.com/peers/peer1.org2.build.com/tls:/etc/hyperledger/fabric/tls
      - /var/run/:/host/var/run/
      - ./:/etc/hyperledger/channel/
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    ports:
      - 10051:10051
    networks:
      - test

  peer0.org3.supplier.com:
    container_name: peer0.org3.supplier.com
    image: hyperledger/fabric-peer:latest
    labels:
      service: hyperledger-fabric
    environment:
      #Generic peer variables
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=ordersFabric_test
      - FABRIC_LOGGING_SPEC=INFO
      #- FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Peer specific variabes
      - CORE_PEER_ID=peer0.org3.supplier.com
      - CORE_PEER_ADDRESS=peer0.org3.supplier.com:11051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:11051
      - CORE_PEER_CHAINCODEADDRESS=peer0.org3.supplier.com:11052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:11052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org3.supplier.com:12051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org3.supplier.com:11051
      - CORE_PEER_LOCALMSPID=Org3MSP
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - ./crypto-config/peerOrganizations/org3.supplier.com/peers/peer0.org3.supplier.com/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/org3.supplier.com/peers/peer0.org3.supplier.com/tls:/etc/hyperledger/fabric/tls
      - /var/run/:/host/var/run/
      - ./:/etc/hyperledger/channel/
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    ports:
      - 11051:11051
    networks:
      - test

  peer1.org3.supplier.com:
    container_name: peer1.org3.supplier.com
    image: hyperledger/fabric-peer:latest
    labels:
      service: hyperledger-fabric
    environment:
      #Generic peer variables
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=ordersFabric_test
      - FABRIC_LOGGING_SPEC=INFO
      #- FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Peer specific variabes
      - CORE_PEER_ID=peer1.org3.supplier.com
      - CORE_PEER_ADDRESS=peer1.org3.supplier.com:12051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:12051
      - CORE_PEER_CHAINCODEADDRESS=peer1.org3.supplier.com:12052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:12052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org3.supplier.com:11051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org3.supplier.com:12051
      - CORE_PEER_LOCALMSPID=Org3MSP
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - ./crypto-config/peerOrganizations/org3.supplier.com/peers/peer1.org3.supplier.com/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/org3.supplier.com/peers/peer1.org3.supplier.com/tls:/etc/hyperledger/fabric/tls
      - /var/run/:/host/var/run/
      - ./:/etc/hyperledger/channel/
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    ports:
      - 12051:12051
    networks:
      - test

  peer0.org4.logistics.com:
    container_name: peer0.org4.logistics.com
    image: hyperledger/fabric-peer:latest
    labels:
      service: hyperledger-fabric
    environment:
      #Generic peer variables
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=ordersFabric_test
      - FABRIC_LOGGING_SPEC=INFO
      #- FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Peer specific variabes
      - CORE_PEER_ID=peer0.org4.logistics.com
      - CORE_PEER_ADDRESS=peer0.org4.logistics.com:13051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:13051
      - CORE_PEER_CHAINCODEADDRESS=peer0.org4.logistics.com:13052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:13052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org4.logistics.com:14051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org4.logistics.com:13051
      - CORE_PEER_LOCALMSPID=Org4MSP
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - ./crypto-config/peerOrganizations/org4.logistics.com/peers/peer0.org4.logistics.com/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/org4.logistics.com/peers/peer0.org4.logistics.com/tls:/etc/hyperledger/fabric/tls
      - /var/run/:/host/var/run/
      - ./:/etc/hyperledger/channel/
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    ports:
      - 13051:13051
    networks:
      - test

  peer1.org4.logistics.com:
    container_name: peer1.org4.logistics.com
    image: hyperledger/fabric-peer:latest
    labels:
      service: hyperledger-fabric
    environment:
      #Generic peer variables
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=ordersFabric_test
      - FABRIC_LOGGING_SPEC=INFO
      #- FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Peer specific variabes
      - CORE_PEER_ID=peer1.org4.logistics.com
      - CORE_PEER_ADDRESS=peer1.org4.logistics.com:14051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:14051
      - CORE_PEER_CHAINCODEADDRESS=peer1.org4.logistics.com:14052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:14052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org4.logistics.com:13051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org4.logistics.com:14051
      - CORE_PEER_LOCALMSPID=Org4MSP
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - ./crypto-config/peerOrganizations/org4.logistics.com/peers/peer1.org4.logistics.com/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/org4.logistics.com/peers/peer1.org4.logistics.com/tls:/etc/hyperledger/fabric/tls
      - /var/run/:/host/var/run/
      - ./:/etc/hyperledger/channel/
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    ports:
      - 14051:14051
    networks:
      - test

  cli1:
    container_name: cli1
    image: hyperledger/fabric-tools:latest
    tty: true
    stdin_open: true
    environment:
      - GOPATH=/opt/gopath
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_ID=cli1
      - CORE_PEER_ADDRESS=peer0.org1.supervisor.com:7051
      - CORE_PEER_LOCALMSPID=Org1MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.supervisor.com/peers/peer0.org1.supervisor.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.supervisor.com/peers/peer0.org1.supervisor.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.supervisor.com/peers/peer0.org1.supervisor.com/tls/ca.crt
      - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.supervisor.com/users/Admin@org1.supervisor.com/msp
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: /bin/bash
    volumes:
      - /var/run/:/host/var/run/
      - ./chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric-cluster/chaincode/go
      - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/
      - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts
    networks:
      - test

  cli2:
    container_name: cli2
    image: hyperledger/fabric-tools:latest
    tty: true
    stdin_open: true
    environment:
      - GOPATH=/opt/gopath
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_ID=cli2
      - CORE_PEER_ADDRESS=peer0.org2.build.com:9051
      - CORE_PEER_LOCALMSPID=Org2MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.build.com/peers/peer0.org2.build.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.build.com/peers/peer0.org2.build.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.build.com/peers/peer0.org2.build.com/tls/ca.crt
      - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.build.com/users/Admin@org2.build.com/msp
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: /bin/bash
    volumes:
      - /var/run/:/host/var/run/
      - ./chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric-cluster/chaincode/go
      - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/
      - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts
    networks:
      - test

  cli3:
    container_name: cli3
    image: hyperledger/fabric-tools:latest
    tty: true
    stdin_open: true
    environment:
      - GOPATH=/opt/gopath
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_ID=cli3
      - CORE_PEER_ADDRESS=peer0.org3.supplier.com:11051
      - CORE_PEER_LOCALMSPID=Org3MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.supplier.com/peers/peer0.org3.supplier.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.supplier.com/peers/peer0.org3.supplier.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.supplier.com/peers/peer0.org3.supplier.com/tls/ca.crt
      - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.supplier.com/users/Admin@org3.supplier.com/msp
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: /bin/bash
    volumes:
      - /var/run/:/host/var/run/
      - ./chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric-cluster/chaincode/go
      - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/
      - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts
    networks:
      - test

  cli4:
    container_name: cli4
    image: hyperledger/fabric-tools:latest
    tty: true
    stdin_open: true
    environment:
      - GOPATH=/opt/gopath
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_ID=cli4
      - CORE_PEER_ADDRESS=peer0.org4.logistics.com:13051
      - CORE_PEER_LOCALMSPID=Org4MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.logistics.com/peers/peer0.org4.logistics.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.logistics.com/peers/peer0.org4.logistics.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.logistics.com/peers/peer0.org4.logistics.com/tls/ca.crt
      - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.logistics.com/users/Admin@org4.logistics.com/msp
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: /bin/bash
    volumes:
      - /var/run/:/host/var/run/
      - ./chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric-cluster/chaincode/go
      - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/
      - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts
    networks:
      - test
```

![截屏2023-10-18 09.23.00](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-18 09.23.00.png)

## 2.*docker-compose*容器网络运行

用docker-compose命令来生成镜像：

```sh
$ docker-compose up -d
$ docker ps -a
```

![截屏2023-10-18 09.24.29](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-18 09.24.29.png)

果在后面需要删除容器可以使用以下命令：

```bash
$ docker rm $(docker ps -a -q)

$ docker-compose up -d
```

# 五、通道相关配置操作

> ## Fabric源码分析-生成Channel.tx通道初始配置文件
>
> Channel提供了多账本的功能，我们创建Channel时首先就是要配置联盟和Channel中包含的组织，之后使用configtxgen生成Channel.tx文件，这个文件内部其实就是创建账本所需要的配置更新。
>
> ### 1.使用
>
> 从fabric源码中复制一份configtx，对其进行修改
>
> ```bash
> cp $GOPATH/src/github.com/hyperledger/fabric/sampleconfig/configtx.yaml .
> ```
>
> 设置一个生成Channe的配置，OrdererOrg/CoreOrg/SupplierOrg/BankOrg需要进行配置，在此省略
>
> ```yaml
> TestTwoOrgsChannel:
>   Consortium: SampleConsortium
>   Application:
>       Organizations:
>                 - *CoreOrg
>                 - *SupplierOrg
>                 - *BankOrg
> ```
>
> 最后，使用下面的命令就可以生成创世块了
>
> ```sh
> configtxgen -profile TestTwoOrgsChannel -outputCreateChannelTx ./mychannel.tx -channelID mychannel
> ```
>
> ### 2.程序分析
>
> configtxgen的程序在`common/tools/configtxgen/main.go`中，主要的功能是获取配置文件，生成ConfigUpdate，包装为一个ConfigUpdate的交易并写入文件。主流程是：
>
> 1. factory.InitFactories(nil) 初始化BCCSP，用来为加密提供服务。
> 2. 获取指定profile的配置，将其序列化为Profile类型。
> 3. 我们设置了outputChannelCreateTx，因此会执行doOutputChannelCreateTx方法。
> 4. 创建一个用来创建Channel的交易，将其写入文件。
>
> #### 2.1 创建Channel的交易文件
>
> 有了Profile配置，首先创建一个ConfigUpdate，将其包装到ConfigUpdateEnvelope中，之后序列化作为Data，添加Header后形成Payload，最后添加签名，封装为Envelope并返回。
>
> ![img](https://upload-images.jianshu.io/upload_images/4747194-3c3734f17aca8c23.png?imageMogr2/auto-orient/strip|imageView2/2/w/764/format/webp)
>
> channel.tx的内容
>
> 因此，我们需要将主要逻辑聚焦于ConfigUpdate的内容。
>
> #### 2.2 ConfigGroup
>
> `NewChannelCreateConfigUpdate`方法会生成一个ConfigUpdate，ConfigUpdate会被发送到orderer来创建一个新的Channel，该方法根据指定的profile的配置中的Application，创建Application的ConfigGroup，ConfigGroup可以理解为一个配置树型，Application中包含了Organizations，Organizations中是三个Org，因此，最终会形成一个Application的配置树。ConfigGroup的结构可以参考[ConfigGroup](https://www.jianshu.com/p/65230bbffb58)，Application的Groups中是组织的配置，在`NewApplicationOrgGroup`中，会对Org的配置组装，读取并验证MSP的相关证书。
>
> #### 2.3 ConfigUpdate
>
> 上面只是将配置转化为ConfigGroup组成的配置树，接下来就是计算ConfigUpdate了，也就是计算配置有那些更新。计算的程序如下，首先会创建一个新的ConfigGroup，其Groups子配置有一个`Application`，对应这我们之前生成的Application的Config，这是因为在`TestTwoOrgsChannel`中，Application是作为一个子级，需要将其放在一个Root配置下。
>
> ```go
> newChannelGroup = &cb.ConfigGroup{
>   Groups: map[string]*cb.ConfigGroup{
>     channelconfig.ApplicationGroupKey: ag,
>   },
> }
> 
> template = proto.Clone(newChannelGroup).(*cb.ConfigGroup)
> template.Groups[channelconfig.ApplicationGroupKey].Values = nil
> template.Groups[channelconfig.ApplicationGroupKey].Policies = nil
> ```
>
> 之后，克隆了一份新创建的ConfigGroup，将其`Application`的子ConfigGroup的Value和Policy设置为nil，之前我们在2.2节构造ConfigGroup时，ConfigGroup会设置默认的一些Ploicy，如果配置了Capabilities，已经设置Value
>
> ```go
> addImplicitMetaPolicyDefaults(applicationGroup)
> 
> if len(conf.Capabilities) > 0 {
>   addValue(applicationGroup, channelconfig.CapabilitiesValue(conf.Capabilities), channelconfig.AdminsPolicyKey)
> }
> ```
>
> template的修改势必会造成配置发生变化，因此下一步就是计算两个ConfigGroup的更新了，我们以template作为原来的配置，newChannelGroup最为更新之后的配置，计算哪些配置发生了更新。虽然这里我们还容易看出来发生了那些变化，但是为了统一处理，还是进行了计算（如果设置了orderingSystemChannelGroup的话，template的方式就不是这么简单的克隆后修改了）。
>
> **计算方法**
>
> 主要是遍历原ConfigGroup的Policy，Value和ConfigGroup，将未发生变化的部分保存到sameSet，发送变化后的配置保存到writeSet中且版本号加1。最后，如果未发生变化，返回的ConfigUpdate的ReadSet和WriteSet均为nil，如果发生了变化，将sameSet分别赋值给ReadSet和WriteSet，保证未发生变化的部分在两个Set中都存在。这样我们就知道了发生变化前后的配置。
> 根据之前template的生成方式，我们可以查看最后的读写集合
>
> ![img](https://upload-images.jianshu.io/upload_images/4747194-8587a8d48006abcb.png?imageMogr2/auto-orient/strip|imageView2/2/w/1029/format/webp)
>
> ConfigUpdate
>
> 在上图中，ReadSet的Application的version为0,WriteSet中version为1,说明发生了变化，通过观察，我们看到ConfigGroup的Policies发生了变化，这与template的修改相符合。其实最终的ConfigUpdate就是要通知，Application的Policy发生了变化，如果设置了某些配置参数的话，Value也会发生变化。
>
> 计算出来ConfigUpdate，最后封装为Envelope后，写入文件中，整个流程就结束了。

## 1.通创建通道和生成通道配置文件

1.进入cli1容器

```bash
$ docker exec -it cli1 bash

#cli1容器内部操作，特别注意-c mychannel名称被系统默认通道名称占用，不建议用户使用

bash-5.1# peer channel create -o orderer0.example.com:7050 -c appchannel -f channel-artifacts/appchannel.tx --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/msp/tlscacerts/tlsca.example.com-cert.pem

#退出容器，回到宿主机
bash-5.1# exit
```

![截屏2023-10-18 09.27.19](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-18 09.27.19.png)

2.将通道文件复制到raft-test项目路径下，然后再复制到其它cli容器内，加入通道

```sh
$ pwd

$ docker cp cli1:/opt/gopath/src/github.com/hyperledger/fabric/peer/appchannel.block ./

$ docker cp appchannel.block cli2:/opt/gopath/src/github.com/hyperledger/fabric/peer

$ docker cp appchannel.block cli3:/opt/gopath/src/github.com/hyperledger/fabric/peer

$ docker cp appchannel.block cli4:/opt/gopath/src/github.com/hyperledger/fabric/peer
```

![截屏2023-10-18 09.29.51](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-18 09.29.51.png)

## 2.加入通道与更新锚点

1.cli1容器操作

```sh
$ docker exec -it cli1 bash

bash-5.1# peer channel join -b appchannel.block

bash-5.1# peer channel update -o orderer0.example.com:7050 -c appchannel -f ./channel-artifacts/Org1MSPanchors.tx \
--tls true \
--cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

#退出容器，回到宿主机
bash-5.1# exit
```

![截屏2023-10-18 09.34.37](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-18 09.34.37.png)

2.cli2容器操作

```sh
$ docker exec -it cli2 bash

bash-5.1# peer channel join -b appchannel.block

bash-5.1# peer channel update -o orderer0.example.com:7050 -c appchannel -f ./channel-artifacts/Org2MSPanchors.tx \
--tls true \
--cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

bash-5.1# exit
```

![截屏2023-10-18 09.36.41](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-18 09.36.41.png)

3.cli3容器操作

```sh
$ docker exec -it cli3 bash

bash-5.1# peer channel join -b appchannel.block

bash-5.1# peer channel update -o orderer0.example.com:7050 -c appchannel -f ./channel-artifacts/Org3MSPanchors.tx \
--tls true \
--cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

bash-5.1# exit
```

![截屏2023-10-18 09.37.42](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-18 09.37.42.png)

4.cli4容器操作

```sh
$ docker exec -it cli4 bash

bash-5.1# peer channel join -b appchannel.block

bash-5.1# peer channel update -o orderer0.example.com:7050 -c appchannel -f ./channel-artifacts/Org4MSPanchors.tx \
--tls true \
--cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

bash-5.1# exit
```

![截屏2023-10-18 09.38.25](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-18 09.38.25.png)

# 六、链码调用

## 1.复制官方链码

> 注意：这里的sacc.go文件目录取决于自己本地中的文件

```sh
$ cd ~/go/src/github.com/hnuorg/raft-test/chaincode/go
$ sudo cp ~/go/src/github.com/hyperledger/fabric-samples/chaincode/sacc/sacc.go .
```

![截屏2023-10-19 21.33.03](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-19 21.33.03.png)

## 2.安装go依赖并打包链码

```bash
$ docker exec -it cli1 bash

#cli1容器内部执行
bash-5.1# cd /opt/gopath/src/github.com/hyperledger/fabric-cluster/chaincode/go/
bash-5.1# ls
sacc.go

bash-5.1# go env -w GOPROXY=https://goproxy.cn,direct
bash-5.1# go env -w GO111MODULE=auto
bash-5.1# go mod init
bash-5.1# go mod tidy
bash-5.1# go mod vendor

bash-5.1# ls
go.mod   go.sum  sacc.go  vendor

bash-5.1# peer lifecycle chaincode package sacc.tar.gz \
--path github.com/hyperledger/fabric-cluster/chaincode/go/ \
--label sacc_1

bash-5.1# ls
go.mod go.sum  sacc.go  sacc.tar.gz  vendor

bash-5.1# echo $PWD
/opt/gopath/src/github.com/hyperledger/fabric-cluster/chaincode/go

bash-5.1# exit
exit
```

![截屏2023-10-20 08.16.19](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.16.19.png)

![截屏2023-10-20 08.17.12](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.17.12.png)

## 3.将打包好的链码复制到四个cli

```sh
$ docker exec -it cli1 bash
bash-5.1# cd /opt/gopath/src/github.com/hyperledger/fabric/peer/
bash-5.1# ls
channel-artifacts  crypto  appchannel.block
bash-5.1# cp /opt/gopath/src/github.com/hyperledger/fabric-cluster/chaincode/go/sacc.tar.gz /opt/gopath/src/github.com/hyperledger/fabric/peer/
bash-5.1# exit
exit

$ sudo docker cp cli1:/opt/gopath/src/github.com/hyperledger/fabric/peer/sacc.tar.gz .

$ ls
chaincode  channel-artifacts  configtx.yaml  crypto-config  crypto-config.yaml  docker-compose.yaml  mychannel.block  sacc.tar.gz

$ sudo docker cp sacc.tar.gz cli2:/opt/gopath/src/github.com/hyperledger/fabric/peer/
$ sudo docker cp sacc.tar.gz cli3:/opt/gopath/src/github.com/hyperledger/fabric/peer/
$ sudo docker cp sacc.tar.gz cli4:/opt/gopath/src/github.com/hyperledger/fabric/peer/
```

![截屏2023-10-20 08.22.30](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.22.30.png)

![截屏2023-10-20 08.24.30](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.24.30.png)

![截屏2023-10-20 08.25.21](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.25.21.png)

## 4.安装链码、批准链码、查看链码

> **在批准链码时，–package-id 的值需要与安装生成的package identifier:值一致**
>
> - cli1容器操作

```sh
$ docker exec -it cli1 bash

bash-5.1# peer lifecycle chaincode install sacc.tar.gz

2022-11-21 05:25:56.660 UTC 0001 INFO [cli.lifecycle.chaincode] submitInstallProposal -> Installed remotely: response:<status:200 payload:"\nGsacc_1:c365af10a4662d7ee6a8a04cd4303c6d84fdd05039843f742e5018d8a5e72a60\022\006sacc_1" > 
2022-11-21 05:25:56.660 UTC 0002 INFO [cli.lifecycle.chaincode] submitInstallProposal -> Chaincode code package identifier: sacc_1:c365af10a4662d7ee6a8a04cd4303c6d84fdd05039843f742e5018d8a5e72a60

bash-5.1# peer lifecycle chaincode queryinstalled
Installed chaincodes on peer:
Package ID: sacc_1:9ffa6d574bee9027d9ae02ad3c8a6fb3c7d0f65e86dcf887e6e33f7216571af8, Label: sacc_1

bash-5.1# peer lifecycle chaincode approveformyorg --channelID appchannel --name sacc --version 1.0 --init-required --package-id sacc_1:62942f6deb64d0af4aed4bb23f41528deeb7a87d9a4daa14042207d9bed8e816 --sequence 1 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

2022-11-21 05:28:15.395 UTC 0001 INFO [cli.lifecycle.chaincode] setOrdererClient -> Retrieved channel (appchannel) orderer endpoint: orderer0.example.com:7050
2022-11-21 05:28:17.537 UTC 0002 INFO [chaincodeCmd] ClientWait -> txid [d0e44affd75649d5f5218d57c08f6959d762d49e5c0e5aaf6cab858c5fff789c] committed with status (VALID) at peer0.org1.supervisor.com:7051

bash-5.1# peer lifecycle chaincode checkcommitreadiness --channelID appchannel --name sacc --version 1.0 --init-required --sequence 1 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --output json

bash-5.1# exit
exit
```

![截屏2023-10-20 08.55.11](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.55.11.png)

在cli2、cli3、cli4容器中的操作与上面类似，所以自行依次来进行执行

cli2

```bash
$ docker exec -it cli2 bash

bash-5.1# peer lifecycle chaincode install sacc.tar.gz

2022-11-21 05:35:20.649 UTC 0001 INFO [cli.lifecycle.chaincode] submitInstallProposal -> Installed remotely: response:<status:200 payload:"\nGsacc_1:c365af10a4662d7ee6a8a04cd4303c6d84fdd05039843f742e5018d8a5e72a60\022\006sacc_1" > 
2022-11-21 05:35:20.649 UTC 0002 INFO [cli.lifecycle.chaincode] submitInstallProposal -> Chaincode code package identifier: sacc_1:c365af10a4662d7ee6a8a04cd4303c6d84fdd05039843f742e5018d8a5e72a60

bash-5.1# peer lifecycle chaincode queryinstalled
Installed chaincodes on peer:
Package ID: sacc_1:9ffa6d574bee9027d9ae02ad3c8a6fb3c7d0f65e86dcf887e6e33f7216571af8, Label: sacc_1

bash-5.1# peer lifecycle chaincode approveformyorg --channelID appchannel --name sacc --version 1.0 --init-required --package-id sacc_1:62942f6deb64d0af4aed4bb23f41528deeb7a87d9a4daa14042207d9bed8e816 --sequence 1 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

2022-11-21 05:37:09.897 UTC 0001 INFO [cli.lifecycle.chaincode] setOrdererClient -> Retrieved channel (appchannel) orderer endpoint: orderer0.example.com:7050
2022-11-21 05:37:12.030 UTC 0002 INFO [chaincodeCmd] ClientWait -> txid [2cad28a3d24ea4fb3f2ebb7712f8513c310b768898bee9252be27ead8017f97a] committed with status (VALID) at peer0.org2.build.com:9051


bash-5.1# peer lifecycle chaincode checkcommitreadiness --channelID appchannel --name sacc --version 1.0 --init-required --sequence 1 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --output json


bash-5.1# exit
exit
```

![截屏2023-10-20 08.55.38](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.55.38.png)

cli3

```bash
$ docker exec -it cli3 bash

bash-5.1# peer lifecycle chaincode install sacc.tar.gz

2022-11-21 05:40:16.322 UTC 0001 INFO [cli.lifecycle.chaincode] submitInstallProposal -> Installed remotely: response:<status:200 payload:"\nGsacc_1:c365af10a4662d7ee6a8a04cd4303c6d84fdd05039843f742e5018d8a5e72a60\022\006sacc_1" > 
2022-11-21 05:40:16.322 UTC 0002 INFO [cli.lifecycle.chaincode] submitInstallProposal -> Chaincode code package identifier: sacc_1:c365af10a4662d7ee6a8a04cd4303c6d84fdd05039843f742e5018d8a5e72a60

bash-5.1# peer lifecycle chaincode queryinstalled
Installed chaincodes on peer:
Package ID: sacc_1:9ffa6d574bee9027d9ae02ad3c8a6fb3c7d0f65e86dcf887e6e33f7216571af8, Label: sacc_1

bash-5.1# peer lifecycle chaincode approveformyorg --channelID appchannel --name sacc --version 1.0 --init-required --package-id sacc_1:62942f6deb64d0af4aed4bb23f41528deeb7a87d9a4daa14042207d9bed8e816 --sequence 1 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

2022-11-21 05:40:59.501 UTC 0001 INFO [cli.lifecycle.chaincode] setOrdererClient -> Retrieved channel (appchannel) orderer endpoint: orderer0.example.com:7050
2022-11-21 05:41:01.648 UTC 0002 INFO [chaincodeCmd] ClientWait -> txid [c8f56485521bb98ccc58be57c78f179595a7b4b478932a6a50e735dc1638190b] committed with status (VALID) at peer0.org3.supplier.com:11051


bash-5.1# peer lifecycle chaincode checkcommitreadiness --channelID appchannel --name sacc --version 1.0 --init-required --sequence 1 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --output json


bash-5.1# exit
exit
```

![截屏2023-10-20 08.55.55](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.55.55.png)

cli4

```bash
$ docker exec -it cli4 bash

bash-5.1# peer lifecycle chaincode install sacc.tar.gz

2022-11-21 05:42:53.021 UTC 0001 INFO [cli.lifecycle.chaincode] submitInstallProposal -> Installed remotely: response:<status:200 payload:"\nGsacc_1:c365af10a4662d7ee6a8a04cd4303c6d84fdd05039843f742e5018d8a5e72a60\022\006sacc_1" > 
2022-11-21 05:42:53.022 UTC 0002 INFO [cli.lifecycle.chaincode] submitInstallProposal -> Chaincode code package identifier: sacc_1:c365af10a4662d7ee6a8a04cd4303c6d84fdd05039843f742e5018d8a5e72a60

bash-5.1# peer lifecycle chaincode queryinstalled
Installed chaincodes on peer:
Package ID: sacc_1:62942f6deb64d0af4aed4bb23f41528deeb7a87d9a4daa14042207d9bed8e816, Label: sacc_1

bash-5.1# peer lifecycle chaincode approveformyorg --channelID appchannel --name sacc --version 1.0 --init-required --package-id sacc_1:62942f6deb64d0af4aed4bb23f41528deeb7a87d9a4daa14042207d9bed8e816 --sequence 1 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

2022-11-21 05:44:19.247 UTC 0001 INFO [cli.lifecycle.chaincode] setOrdererClient -> Retrieved channel (appchannel) orderer endpoint: orderer0.example.com:7050
2022-11-21 05:44:21.394 UTC 0002 INFO [chaincodeCmd] ClientWait -> txid [2c2c9dfde7cbedbc0e938cd49470453fe4f8bb5fc98a7cc25d67b2f66c94abbd] committed with status (VALID) at peer0.org4.logistics.com:13051



bash-5.1# peer lifecycle chaincode checkcommitreadiness --channelID appchannel --name sacc --version 1.0 --init-required --sequence 1 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --output json

bash-5.1# exit
exit
```

![截屏2023-10-20 08.56.15](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.56.15.png)

## 5.提交链码

cli1容器下来进行提交

```sh
$ docker exec -it cli1 bash

bash-5.1# peer lifecycle chaincode commit -o orderer0.example.com:7050 \
--channelID appchannel \
--name sacc \
--version 1.0 \
--sequence 1 \
--init-required \
--tls true \
--cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem \
--peerAddresses peer0.org1.supervisor.com:7051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.supervisor.com/peers/peer0.org1.supervisor.com/tls/ca.crt \
--peerAddresses peer0.org2.build.com:9051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.build.com/peers/peer0.org2.build.com/tls/ca.crt \
--peerAddresses peer0.org3.supplier.com:11051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.supplier.com/peers/peer0.org3.supplier.com/tls/ca.crt \
--peerAddresses peer0.org4.logistics.com:13051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.logistics.com/peers/peer0.org4.logistics.com/tls/ca.crt

2022-11-21 05:46:21.295 UTC 0001 INFO [chaincodeCmd] ClientWait -> txid [30cff5a0ec784602af2b6157c322b6945b4b359b698e9acb6d8c2c567ed73499] committed with status (VALID) at peer0.org4.logistics.com:13051
2022-11-21 05:46:21.296 UTC 0002 INFO [chaincodeCmd] ClientWait -> txid [30cff5a0ec784602af2b6157c322b6945b4b359b698e9acb6d8c2c567ed73499] committed with status (VALID) at peer0.org3.supplier.com:11051
2022-11-21 05:46:21.296 UTC 0003 INFO [chaincodeCmd] ClientWait -> txid [30cff5a0ec784602af2b6157c322b6945b4b359b698e9acb6d8c2c567ed73499] committed with status (VALID) at peer0.org2.build.com:9051
2022-11-21 05:46:21.296 UTC 0004 INFO [chaincodeCmd] ClientWait -> txid [30cff5a0ec784602af2b6157c322b6945b4b359b698e9acb6d8c2c567ed73499] committed with status (VALID) at peer0.org1.supervisor.com:7051
```

![截屏2023-10-20 08.56.52](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.56.52.png)

## 6.链码初始化

> 接着上面的命令进行执行

```bash
bash-5.1# peer chaincode invoke -o orderer0.example.com:7050 \
--isInit \
--ordererTLSHostnameOverride orderer0.example.com \
--tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C appchannel -n sacc \
--peerAddresses peer0.org1.supervisor.com:7051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.supervisor.com/peers/peer0.org1.supervisor.com/tls/ca.crt \
--peerAddresses peer0.org2.build.com:9051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.build.com/peers/peer0.org2.build.com/tls/ca.crt \
--peerAddresses peer0.org3.supplier.com:11051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.supplier.com/peers/peer0.org3.supplier.com/tls/ca.crt \
--peerAddresses peer0.org4.logistics.com:13051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.logistics.com/peers/peer0.org4.logistics.com/tls/ca.crt -c '{"Args":["a","bb"]}' 

022-11-23 07:24:51.993 UTC 0001 INFO [chaincodeCmd] chaincodeInvokeOrQuery -> Chaincode invoke successful. result: status:200 
```

![截屏2023-10-20 08.57.14](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.57.14.png)

## 7.查询数据

```bash
bash-5.1# peer chaincode query -C appchannel -n sacc -c '{"Args":["query","a"]}'
bb
```

## 8.调用链码

```sh
bash-5.1# peer chaincode invoke -o orderer0.example.com:7050 \
--tls true \
--cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C appchannel -n sacc \
--peerAddresses peer0.org1.supervisor.com:7051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.supervisor.com/peers/peer0.org1.supervisor.com/tls/ca.crt \
--peerAddresses peer0.org2.build.com:9051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.build.com/peers/peer0.org2.build.com/tls/ca.crt \
--peerAddresses peer0.org3.supplier.com:11051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.supplier.com/peers/peer0.org3.supplier.com/tls/ca.crt \
--peerAddresses peer0.org4.logistics.com:13051 \
--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.logistics.com/peers/peer0.org4.logistics.com/tls/ca.crt -c '{"Args":["set","a","cc"]}'

2022-11-23 07:28:40.077 UTC 0001 INFO [chaincodeCmd] chaincodeInvokeOrQuery -> Chaincode invoke successful. result: status:200 payload:"cc" 
```

![截屏2023-10-20 08.58.05](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.58.05.png)

## 9.再次查询链码

```shell
bash-5.1# peer chaincode query -C appchannel -n sacc -c '{"Args":["query","a"]}'
cc
```

![截屏2023-10-20 08.58.19](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.58.19.png)

## 10.关闭删除镜像

到这里一个完整的网络就搭建并测试成功了，所以就可以关闭并删除镜像了

```sh
$ docker stop $(docker ps -a -q)
$ docker rm $(docker ps -a -q)
```

![截屏2023-10-20 08.59.06](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.59.06.png)

# 七、实验总结

实验的相关参考资料如下：

- https://blog.csdn.net/qq_45469783/article/details/119298677

- https://www.whcsrl.com/blog/1029128#4_1055

# 八、报错及解决方案

**1.生成组织证书不全**

使用cryptogen generate --config=crypto-config.yaml命令时，可以成功运行，但结果只生成了org1.example.com和prg2.example.com两个文件

![截屏2023-10-16 22.23.30](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 22.23.30.png)

![截屏2023-10-16 22.55.56](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 22.55.56.png)

**解决方案：**只生成两个example文件是因为crypto-config.yaml文件里默认只配置了这两个，要根据实验指南修改这个yaml文件。

**2.无法生成组织证书**

生成组织证书时，报错如下：

![截屏2023-10-16 22.52.14](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 22.52.14.png)

**解决方案：**原因是没有把二进制文件

```bash
sudo vim ~/.bashrc

#在环境变量中
export PATH=$PATH:/go/src/github.com/hyperledger/fabric-samples/bin

source ~/.bashrc
```

之后就可以成功生成组织证书了：

![截屏2023-10-16 23.00.22](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-16 23.00.22.png)

**3.Error: failed to endorse chaincode install: rpc error: code = Unknown desc = error validating proposal: access denied: channel [] creator org unknown, creator is malformed**

安装链码时，报错：

![截屏2023-10-20 08.46.40](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-20 08.46.40.png)

**解决方案：**可以看到sacc.tar.gz是红的，说明我们并没有权限，无法进行解压缩之类的操作。因此用chmod 777给他最高权限即可

# 九、实验总结与心得

在本周的实验中，我参与了一项颇具挑战性的任务：在单机环境下部署Hyperledger Fabric 2.4网络，包括3个Orderer节点、4个Organization节点和2个Peer节点，每个组织有4个用户。通过这个实验，我对Hyperledger Fabric 2.4的应用和原理有了更深入的了解。

在实验过程中，我深感Hyperledger Fabric 2.4的强大和灵活性。通过脚本和命令行工具，我们可以轻松地部署和管理节点，实现网络的启动、停止、升级等操作。而且，Fabric的网络结构使得节点之间的通信更加安全和可靠。同时，我也深刻体会到了Hyperledger Fabric的复杂性和特点。首先，Fabric采用了基于Docker的容器技术，使得节点部署和管理变得更加便捷。其次，Fabric支持多层次的安全机制，包括TLS和CA证书等，保证了网络通信的安全性。最后，Fabric具有丰富的链码和API接口，使得应用开发变得更加灵活和方便。

我首先阅读了Hyperledger Fabric的官方文档，了解了其基本概念和架构，并且明确了实验的目的和步骤。然后，我在单机环境下部署了Hyperledger Fabric网络，包括3个Orderer节点、4个Org节点和2个Peer节点，每个节点都有相应的CA和TLS证书。

然后，我使用了Docker和Fabric-samples提供的脚本，这些工具使得节点部署变得更加便捷。尽管如此，我仍然遇到了许多问题，比如节点间通信失败、链码调用错误等。这些问题主要源于网络配置和链码编写的问题，通过查找文档和参考解决方案，我逐渐解决了这些问题。

当然，由于自己的操作不当，我也遇到了一些比较棘手的报错。印象比较深刻的是，在部署Orderer节点时，我曾遇到一个网络连接问题。经过分析，我认为可能是由于Orderer节点的网络设置不正确导致的。于是，我重新检查了网络配置，并调整了Orderer节点的相关设置，最终成功地解决了问题。这次经历让我认识到，对于任何技术问题，都需要沉着冷静地分析，找出问题的根源，才能有效地解决问题。

通过这次实验，我不仅掌握了Hyperledger Fabric 2.4单机容器部署的方法，还对Fabric网络的运行机制有了深入的理解。此外，我还发现了一些自己在技术应用方面的不足，例如对网络配置的理解不够深入，对脚本工具的使用不够熟练等。这些发现让我更加明确了自己需要进一步提升的技能和知识。

展望未来，我将继续深入学习和研究Hyperledger Fabric的相关知识，提升自己的技能水平。同时，我也将尝试将所学知识应用到实际项目中，通过实践来加深对Fabric的理解。我相信，随着我对Fabric技术的不断深入学习和应用，我一定能够在区块链领域取得更多的成果。

