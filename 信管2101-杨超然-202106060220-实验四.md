 <img src="/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-08-31 09.48.04.png" alt="截屏2023-08-31 09.48.04" style="zoom:60%;" />

| **报告名称**：   | 实验四：Git&Hyperledger Fabric编译与测试网络实践 |
| ---------------- | ------------------------------------------------ |
| **学生姓名：**   | 杨超然                                           |
| **学生学号：**   | 202106060220                                     |
| **专业班级：**   | 信管2101班                                       |
| **学**  **院：** | 工商管理学院                                     |
| **指导老师：**   | 周中定                                           |
| **日  期：**     | 2023.10.7                                        |

------

[TOC]



------

# 一、Gitee相关运用实践

## （一）注册Gitee

使用GitHub时，国内的用户经常遇到的问题是访问速度太慢，有时候还会出现无法连接的情况（原因你懂的)。

如果我们希望体验Git飞一般的速度，可以使用国内的Git托管服务——[Gitee](gitee.com)。和GitHub相比，Gitee也提供免费的Git仓库。此外，还集成了代码质量检测、项目演示等功能。对于团队协作开发，Gitee还提供了项目管理、代码托管、文档管理的服务，5人以下小团队免费。

Gitee的免费版本也提供私有库功能，只是有5人的成员上限。

首先进行注册：

![截屏2023-10-08 08.54.47](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 08.54.47.png)

## （二）准备工作

### 1.安装git-bit

[Git![img](https://git-scm.com/favicon.ico)https://git-scm.com/](https://git-scm.com/)

在macOS系统下，终端输入brew install git下载：

![截屏2023-10-08 09.16.32](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 09.16.32.png)

### 2.配置公钥

使用Gitee和使用GitHub类似，我们在Gitee上注册账号并登录后，需要先上传自己的SSH公钥。选择右上角用户头像 -> 菜单“修改资料”，然后选择“SSH公钥”，填写一个便于识别的标题，然后把用户主目录下的.ssh/id_rsa.pub文件的内容粘贴进去,详情见[SSH 公钥设置](https://help.gitee.com/base/account/SSH公钥设置)

![截屏2023-10-08 09.05.02](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 09.05.02.png)

测试是否连接到远程自己的账号：

```terminal
 ssh -T git@gitee.com
```

![截屏2023-10-08 09.21.34](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 09.21.34.png)

## （三）创建远程仓库

![截屏2023-10-08 09.25.22](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 09.25.22.png)

**注：**项目名称最好与仓库名称相同

然后，我们进行全局设置，并在本地库上使用命令 git remote add 把它和Gitee的远程库关联：

```terminal
git config --global user.name "CrYang03"
git config --global user.email "1006238039@qq.com"
```

```terminal
mkdir gin-gonic
cd gin-gonic
git init 
touch README.md
git add README.md
git commit -m "first commit"
git remote add origin https://gitee.com/cryang03/gin-gonic.git
git push -u origin "master"
```

输入git  remote -v查看远程库信息：

![截屏2023-10-08 09.33.17](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 09.33.17.png)

## （四）将本地的新项目上传至新建仓库

![截屏2023-10-08 09.50.29](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 09.50.29.png)

```terminal
cd /Users/yangchaoran/Desktop/go
git init
touch README.md
git add .
git commit -m "first commit"
git remote add origin https://gitee.com/cryang03/go.git
git push -u origin "master"
```

![截屏2023-10-08 10.16.15](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 10.16.15.png)

# 二、Hyperledger Fabric本地编译实践

## （一）获取Fabric源码

**注：**如果使用 1.13 之前版本的 Go 环境，需要将 Fabric 项目放到 $GOPATH 路径下。

![截屏2023-10-09 09.52.50](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 09.52.50.png)

![截屏2023-10-09 10.06.01](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.06.01.png)

如下命令所示，创建 `$GOPATH/src/github.com/hyperledger` 目录结构并切换到该路径：

```shell
$ cd ~
$ sudo apt install jq gcc make
$ mkdir -p ~/go/src ~/go/pkg ~/go/bin
$ mkdir -p $GOPATH/src/github.com/hyperledger
$ cd $GOPATH/src/github.com/hyperledger
```

![截屏2023-10-09 10.06.59](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.06.59.png)

获取 Peer 和 Orderer 组件编译所需要的代码，两者目前在同一个 fabric 仓库中：

```shell
$ git clone https://github.com/hyperledger/fabric.git
$ cd fabric
$ git branch -a
$ git checkout -b v2.5.3
$ git branch
```

![截屏2023-10-09 10.44.09](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.44.09.png)

![截屏2023-10-09 21.14.52](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 21.14.52.png)

为节约下载时间，读者可以指定 `--single-branch -b master --depth 1` 命令选项来指定只获取 master 分支最新代码：

```shell
$ git clone --single-branch -b master --depth 1 https://github.com/hyperledger/fabric.git
```

![截屏2023-10-09 10.07.48](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.07.48.png)

Fabric CA 组件在独立的 fabric-ca 仓库中，可以通过如下命令获取：

```shell
$ cd $GOPATH/src/github.com/hyperledger
$ git clone https://github.com/hyperledger/fabric-ca.git
$ git checkout -b v1.5.7
$ git branch
```

![截屏2023-10-09 10.23.12](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.23.12.png)

![截屏2023-10-09 10.40.53](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.40.53.png)

最后，检查确认 fabric 和 fabric-ca 两个仓库下载成功：

```shell
$ ls $GOPATH/src/github.com/hyperledger
```

![截屏2023-10-09 10.46.26](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.46.26.png)

## （二）编译脚本文件（Makefile）

```makefile
# Copyright IBM Corp All Rights Reserved.
# Copyright London Stock Exchange Group All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# -------------------------------------------------------------
# This makefile defines the following targets
#
#   - all (default) - builds all targets and runs all non-integration tests/checks
#   - basic-checks - performs basic checks like license, spelling, trailing spaces and linter
#   - check-deps - check for vendored dependencies that are no longer used
#   - checks - runs all non-integration tests/checks
#   - clean-all - superset of 'clean' that also removes persistent state
#   - clean - cleans the build area
#   - configtxgen - builds a native configtxgen binary
#   - configtxlator - builds a native configtxlator binary
#   - cryptogen - builds a native cryptogen binary
#   - desk-check - runs linters and verify to test changed packages
#   - dist-clean - clean release packages for all target platforms
#   - docker[-clean] - ensures all docker images are available[/cleaned]
#   - docker-list - generates a list of docker images that 'make docker' produces
#   - docker-tag-latest - re-tags the images made by 'make docker' with the :latest tag
#   - docker-tag-stable - re-tags the images made by 'make docker' with the :stable tag
#   - docker-thirdparty - pulls thirdparty images (couchdb, etc)
#   - docs - builds the documentation in html format
#   - gotools - installs go tools like golint
#   - help-docs - generate the command reference docs
#   - integration-test-prereqs - setup prerequisites for integration tests
#   - integration-test - runs the integration tests
#   - ledgerutil - builds a native ledgerutil binary
#   - license - checks go source files for Apache license header
#   - linter - runs all code checks
#   - native - ensures all native binaries are available
#   - orderer - builds a native fabric orderer binary
#   - orderer-docker[-clean] - ensures the orderer container is available[/cleaned]
#   - osnadmin - builds a native fabric osnadmin binary
#   - peer - builds a native fabric peer binary
#   - peer-docker[-clean] - ensures the peer container is available[/cleaned]
#   - profile - runs unit tests for all packages in coverprofile mode (slow)
#   - protos - generate all protobuf artifacts based on .proto files
#   - publish-images - publishes release docker images to nexus3 or docker hub.
#   - release-all - builds release packages for all target platforms
#   - release - builds release packages for the host platform
#   - tools-docker[-clean] - ensures the tools container is available[/cleaned]
#   - unit-test-clean - cleans unit test state (particularly from docker)
#   - unit-test - runs the go-test based unit tests
#   - verify - runs unit tests for only the changed package tree

UBUNTU_VER ?= 22.04
FABRIC_VER ?= 2.5.3

# 3rd party image version
# These versions are also set in the runners in ./integration/runners/
COUCHDB_VER ?= 3.3.2

# Disable implicit rules
.SUFFIXES:
MAKEFLAGS += --no-builtin-rules

BUILD_DIR ?= build

EXTRA_VERSION ?= $(shell git rev-parse --short HEAD)
PROJECT_VERSION=$(FABRIC_VER)-snapshot-$(EXTRA_VERSION)

# TWO_DIGIT_VERSION is derived, e.g. "2.0", especially useful as a local tag
# for two digit references to most recent baseos and ccenv patch releases
# TWO_DIGIT_VERSION removes the (optional) semrev 'v' character from the git
# tag triggering a Fabric release.
TWO_DIGIT_VERSION = $(shell echo $(FABRIC_VER) | sed -e  's/^v\(.*\)/\1/' | cut -d '.' -f 1,2)

PKGNAME = github.com/hyperledger/fabric
ARCH=$(shell go env GOARCH)
MARCH=$(shell go env GOOS)-$(shell go env GOARCH)

# defined in common/metadata/metadata.go
METADATA_VAR = Version=$(FABRIC_VER)
METADATA_VAR += CommitSHA=$(EXTRA_VERSION)
METADATA_VAR += BaseDockerLabel=$(BASE_DOCKER_LABEL)
METADATA_VAR += DockerNamespace=$(DOCKER_NS)

GO_VER = 1.20.8
GO_TAGS ?=

RELEASE_EXES = orderer $(TOOLS_EXES)
RELEASE_IMAGES = baseos ccenv orderer peer tools
RELEASE_PLATFORMS = darwin-amd64 darwin-arm64 linux-amd64 linux-arm64 windows-amd64
TOOLS_EXES = configtxgen configtxlator cryptogen discover ledgerutil osnadmin peer

pkgmap.configtxgen    := $(PKGNAME)/cmd/configtxgen
pkgmap.configtxlator  := $(PKGNAME)/cmd/configtxlator
pkgmap.cryptogen      := $(PKGNAME)/cmd/cryptogen
pkgmap.discover       := $(PKGNAME)/cmd/discover
pkgmap.ledgerutil     := $(PKGNAME)/cmd/ledgerutil
pkgmap.orderer        := $(PKGNAME)/cmd/orderer
pkgmap.osnadmin       := $(PKGNAME)/cmd/osnadmin
pkgmap.peer           := $(PKGNAME)/cmd/peer

.DEFAULT_GOAL := all

include docker-env.mk
include gotools.mk

.PHONY: all
all: check-go-version native docker checks

.PHONY: checks
checks: basic-checks unit-test integration-test

.PHONY: basic-checks
basic-checks: check-go-version license spelling references trailing-spaces linter check-help-docs check-metrics-doc filename-spaces check-swagger

.PHONY: desk-checks
desk-check: checks verify

.PHONY: help-docs
help-docs: native
	@scripts/help_docs.sh

.PHONY: check-help-docs
check-help-docs: native
	@scripts/help_docs.sh check

.PHONY: spelling
spelling: gotool.misspell
	@scripts/check_spelling.sh

.PHONY: references
references:
	@scripts/check_references.sh

.PHONY: license
license:
	@scripts/check_license.sh

.PHONY: trailing-spaces
trailing-spaces:
	@scripts/check_trailingspaces.sh

.PHONY: gotools
gotools: gotools-install

.PHONY: check-go-version
check-go-version:
	@scripts/check_go_version.sh $(GO_VER)

.PHONY: integration-test
integration-test: integration-test-prereqs
	./scripts/run-integration-tests.sh $(INTEGRATION_TEST_SUITE)

.PHONY: integration-test-prereqs
integration-test-prereqs: gotool.ginkgo baseos-docker ccenv-docker docker-thirdparty ccaasbuilder

.PHONY: unit-test
unit-test: unit-test-clean docker-thirdparty-couchdb
	./scripts/run-unit-tests.sh

.PHONY: unit-tests
unit-tests: unit-test

# Pull thirdparty docker images based on the latest baseimage release version
# Also pull ccenv-1.4 for compatibility test to ensure pre-2.0 installed chaincodes
# can be built by a peer configured to use the ccenv-1.4 as the builder image.
.PHONY: docker-thirdparty
docker-thirdparty: docker-thirdparty-couchdb
	docker pull hyperledger/fabric-ccenv:1.4

.PHONY: docker-thirdparty-couchdb
docker-thirdparty-couchdb:
	docker pull couchdb:${COUCHDB_VER}

.PHONY: verify
verify: export JOB_TYPE=VERIFY
verify: unit-test

.PHONY: profile
profile: export JOB_TYPE=PROFILE
profile: unit-test

.PHONY: linter
linter: check-deps gotool.goimports gotool.gofumpt gotool.staticcheck
	@echo "LINT: Running code checks.."
	./scripts/golinter.sh

.PHONY: check-deps
check-deps:
	@echo "DEP: Checking for dependency issues.."
	./scripts/check_deps.sh

.PHONY: check-metrics-docs
check-metrics-doc:
	@echo "METRICS: Checking for outdated reference documentation.."
	./scripts/metrics_doc.sh check

.PHONY: generate-metrics-docs
generate-metrics-doc:
	@echo "Generating metrics reference documentation..."
	./scripts/metrics_doc.sh generate

.PHONY: check-swagger
check-swagger: gotool.swagger
	@echo "SWAGGER: Checking for outdated swagger..."
	./scripts/swagger.sh check

.PHONY: generate-swagger
generate-swagger: gotool.swagger
	@echo "Generating swagger..."
	./scripts/swagger.sh generate

.PHONY: protos
protos: gotool.protoc-gen-go
	@echo "Compiling non-API protos..."
	./scripts/compile_protos.sh

.PHONY: native
native: $(RELEASE_EXES)

.PHONY: tools
tools: $(TOOLS_EXES)

.PHONY: $(RELEASE_EXES)
$(RELEASE_EXES): %: $(BUILD_DIR)/bin/%

$(BUILD_DIR)/bin/%: GO_LDFLAGS = $(METADATA_VAR:%=-X $(PKGNAME)/common/metadata.%)
$(BUILD_DIR)/bin/%:
	@echo "Building $@"
	@mkdir -p $(@D)
	GOBIN=$(abspath $(@D)) go install -tags "$(GO_TAGS)" -ldflags "$(GO_LDFLAGS)" -buildvcs=false $(pkgmap.$(@F))
	@touch $@

.PHONY: docker
docker: $(RELEASE_IMAGES:%=%-docker) ccaasbuilder

.PHONY: $(RELEASE_IMAGES:%=%-docker)
$(RELEASE_IMAGES:%=%-docker): %-docker: $(BUILD_DIR)/images/%/$(DUMMY)

$(BUILD_DIR)/images/baseos/$(DUMMY):  BUILD_CONTEXT=images/baseos
$(BUILD_DIR)/images/ccenv/$(DUMMY):   BUILD_CONTEXT=images/ccenv
$(BUILD_DIR)/images/peer/$(DUMMY):    BUILD_ARGS=--build-arg GO_TAGS=${GO_TAGS}
$(BUILD_DIR)/images/orderer/$(DUMMY): BUILD_ARGS=--build-arg GO_TAGS=${GO_TAGS}
$(BUILD_DIR)/images/tools/$(DUMMY):   BUILD_ARGS=--build-arg GO_TAGS=${GO_TAGS}

$(BUILD_DIR)/images/%/$(DUMMY):
	@echo "Building Docker image $(DOCKER_NS)/fabric-$*"
	@mkdir -p $(@D)
	$(DBUILD) -f images/$*/Dockerfile \
		--build-arg GO_VER=$(GO_VER) \
		--build-arg UBUNTU_VER=$(UBUNTU_VER) \
		--build-arg FABRIC_VER=$(FABRIC_VER) \
		--build-arg TARGETARCH=$(ARCH) \
		--build-arg TARGETOS=linux \
		$(BUILD_ARGS) \
		-t $(DOCKER_NS)/fabric-$* ./$(BUILD_CONTEXT)

# builds release packages for the host platform
.PHONY: release
release: check-go-version $(MARCH:%=release/%)

# builds release packages for all target platforms
.PHONY: release-all
release-all: check-go-version $(RELEASE_PLATFORMS:%=release/%)

.PHONY: $(RELEASE_PLATFORMS:%=release/%)
$(RELEASE_PLATFORMS:%=release/%): GO_LDFLAGS = $(METADATA_VAR:%=-X $(PKGNAME)/common/metadata.%)
$(RELEASE_PLATFORMS:%=release/%): release/%: $(foreach exe,$(RELEASE_EXES),release/%/bin/$(exe))
$(RELEASE_PLATFORMS:%=release/%): release/%: ccaasbuilder/%

# explicit targets for all platform executables
$(foreach platform, $(RELEASE_PLATFORMS), $(RELEASE_EXES:%=release/$(platform)/bin/%)):
	$(eval platform = $(patsubst release/%/bin,%,$(@D)))
	$(eval GOOS = $(word 1,$(subst -, ,$(platform))))
	$(eval GOARCH = $(word 2,$(subst -, ,$(platform))))
	@echo "Building $@ for $(GOOS)-$(GOARCH)"
	mkdir -p $(@D)
	GOOS=$(GOOS) GOARCH=$(GOARCH) go build -o $@ -tags "$(GO_TAGS)" -ldflags "$(GO_LDFLAGS)" -buildvcs=false $(pkgmap.$(@F))

.PHONY: dist
dist: dist-clean dist/$(MARCH)

.PHONY: dist-all
dist-all: dist-clean $(RELEASE_PLATFORMS:%=dist/%)
dist/%: release/% ccaasbuilder
	mkdir -p release/$(@F)/config
	cp -r sampleconfig/*.yaml release/$(@F)/config
	cd release/$(@F) && tar -czvf hyperledger-fabric-$(@F).$(PROJECT_VERSION).tar.gz *

.PHONY: docker-list
docker-list: $(RELEASE_IMAGES:%=%-docker-list)
%-docker-list:
	@echo $(DOCKER_NS)/fabric-$*:$(DOCKER_TAG)

.PHONY: docker-clean
docker-clean: $(RELEASE_IMAGES:%=%-docker-clean)
%-docker-clean:
	-@for image in "$$(docker images --quiet --filter=reference='$(DOCKER_NS)/fabric-$*')"; do \
		[ -z "$$image" ] || docker rmi -f $$image; \
	done
	-@rm -rf $(BUILD_DIR)/images/$* || true

.PHONY: docker-tag-latest
docker-tag-latest: $(RELEASE_IMAGES:%=%-docker-tag-latest)
%-docker-tag-latest:
	docker tag $(DOCKER_NS)/fabric-$*:$(DOCKER_TAG) $(DOCKER_NS)/fabric-$*:latest

.PHONY: docker-tag-stable
docker-tag-stable: $(RELEASE_IMAGES:%=%-docker-tag-stable)
%-docker-tag-stable:
	docker tag $(DOCKER_NS)/fabric-$*:$(DOCKER_TAG) $(DOCKER_NS)/fabric-$*:stable

.PHONY: publish-images
publish-images: $(RELEASE_IMAGES:%=%-publish-images)
%-publish-images:
	@docker login $(DOCKER_HUB_USERNAME) $(DOCKER_HUB_PASSWORD)
	@docker push $(DOCKER_NS)/fabric-$*:$(PROJECT_VERSION)

.PHONY: clean
clean: docker-clean unit-test-clean release-clean
	-@rm -rf $(BUILD_DIR)

.PHONY: clean-all
clean-all: clean gotools-clean dist-clean
	-@rm -rf /var/hyperledger/*
	-@rm -rf docs/build/

.PHONY: dist-clean
dist-clean:
	-@for platform in $(RELEASE_PLATFORMS) ""; do \
		[ -z "$$platform" ] || rm -rf release/$${platform}/hyperledger-fabric-$${platform}.$(PROJECT_VERSION).tar.gz; \
	done

.PHONY: release-clean
release-clean: $(RELEASE_PLATFORMS:%=%-release-clean)
%-release-clean:
	-@rm -rf release/$*

.PHONY: unit-test-clean
unit-test-clean:

.PHONY: filename-spaces
spaces:
	@scripts/check_file_name_spaces.sh

.PHONY: docs
docs:
	@docker run --rm -v $$(pwd):/docs n42org/tox:3.4.0 sh -c 'cd /docs && tox -e docs'

.PHONY: ccaasbuilder-clean
ccaasbuilder-clean/%:
	$(eval platform = $(patsubst ccaasbuilder/%,%,$@) )
	cd ccaas_builder &&	rm -rf $(strip $(platform))

.PHONY: ccaasbuilder
ccaasbuilder/%: ccaasbuilder-clean
	$(eval platform = $(patsubst ccaasbuilder/%,%,$@) )
	$(eval GOOS = $(word 1,$(subst -, ,$(platform))))
	$(eval GOARCH = $(word 2,$(subst -, ,$(platform))))
	@mkdir -p release/$(strip $(platform))/builders/ccaas/bin
	cd ccaas_builder && go test -v ./cmd/detect && GOOS=$(GOOS) GOARCH=$(GOARCH) go build -buildvcs=false -o ../release/$(strip $(platform))/builders/ccaas/bin/ ./cmd/detect/
	cd ccaas_builder && go test -v ./cmd/build && GOOS=$(GOOS) GOARCH=$(GOARCH) go build -buildvcs=false -o ../release/$(strip $(platform))/builders/ccaas/bin/ ./cmd/build/
	cd ccaas_builder && go test -v ./cmd/release && GOOS=$(GOOS) GOARCH=$(GOARCH) go build -buildvcs=false -o ../release/$(strip $(platform))/builders/ccaas/bin/ ./cmd/release/

ccaasbuilder: ccaasbuilder/$(MARCH)

.PHONY: scan
scan: scan-govulncheck

.PHONY: scan-govulncheck
scan-govulncheck: gotool.govulncheck
	govulncheck ./...

```

![截屏2023-10-09 16.45.16](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 16.45.16.png)

## （三）编译安装Peer组件

配置版本号和编译参数：

```shell
$ PROJECT_VERSION=2.5.3
$ LD_FLAGS="-X github.com/hyperledger/fabric/common/metadata.Version=${PROJECT_VERSION} \
            -X github.com/hyperledger/fabric/common/metadata.BaseDockerLabel=org.hyperledger.fabric \
            -X github.com/hyperledger/fabric/common/metadata.DockerNamespace=hyperledger \
            -X github.com/hyperledger/fabric/common/metadata.BaseDockerNamespace=hyperledger"
```

**方式1：**通过如下命令编译并安装 fabric 的 peer 组件到 $GOPATH/bin 下：

```shell
$ cd ~/go/src/github.com/hyperledger/fabric
$ CGO_CFLAGS=" " go install -tags "" -ldflags "$LD_FLAGS" \github.com/hyperledger/fabric/cmd/peer
```

![截屏2023-10-09 16.52.13](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 16.52.13.png)

**方式2：**当然，用户也可直接使用源码中的 Makefile 来进行编译，相关命令如下：

```shell
$ make peer
```

这种情况下编译生成的 peer 组件会默认放在 *build/bin* 路径下。

## （四）**编译安装 Orderer 组件**

**方式1：**通过如下命令编译并安装 fabric orderer 组件到 $GOPATH/bin 下：

```shell
$ CGO_CFLAGS=" " go install -tags "" -ldflags "$LD_FLAGS" \
github.com/hyperledger/fabric/cmd/orderer
```

![截屏2023-10-09 16.54.41](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 16.54.41.png)

**方式2：**同样的，也可使用 Makefile 来编译安装 orderer 组件到 build/bin 路径下：

```shell
$ make orderer
```

## （五）**编译安装 Fabric CA 组件**

采用如下命令编译并安装 fabric-ca 相关组件到 $GOPATH/bin 下：

```bash
$ cd ~/go/src/github.com/hyperledger/fabric-ca
$ go install -ldflags "-X github.com/hyperledger/fabric-ca/lib/metadata.Version=$PROJECT_VERSION" \
github.com/hyperledger/fabric-ca/cmd/...

或
$ go install github.com/hyperledger/fabric-ca/cmd/...

或链接静态库
$go install -ldflags "-X github.com/hyperledger/fabric-ca/lib/metadata.Version=$PROJECT_VERSION\
-linkmode external -extldflags '-static -lpthread'" \
github.com/hyperledger/fabric-ca/cmd/...
```

![截屏2023-10-09 16.56.07](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 16.56.07.png)

## （六）**编译安装配置辅助工具**

Fabric 中还提供了一系列配置辅助工具，包括：

- cryptogen（本地生成组织结构和身份文件）
- configtxgen（生成配置区块和配置交易）
- configtxlator（解析转换配置信息）
- discover（拓扑探测）
- idemixgen（Idemix 证书生成）等

可以通过如下命令来快速编译和安装：

```shell
# 编译安装 cryptogen，等价于执行 make cryptogen
$ CGO_CFLAGS=" " \
go install -tags "" -ldflags "$LD_FLAGS" \
github.com/hyperledger/fabric/cmd/cryptogen

# 编译安装 configtxgen，等价于执行 make configtxgen
$ CGO_CFLAGS=" " \
go install -tags "" -ldflags "$LD_FLAGS" \
github.com/hyperledger/fabric/cmd/configtxgen

# 编译安装 configtxlator，等价于执行 make configtxlator
$ CGO_CFLAGS=" " \
go install -tags "" -ldflags "$LD_FLAGS" \
github.com/hyperledger/fabric/cmd/configtxlator

# 编译安装 discover，等价于执行 make discover
$ CGO_CFLAGS=" " \
go install -tags "" -ldflags "$LD_FLAGS" \
github.com/hyperledger/fabric/cmd/discover

# 编译安装 idemixgen，等价于执行 make idemixgen
# fabric 2.5.3没有idemixen,另外新增了ledgerutil,不在编译该命令
$ CGO_CFLAGS=" " \
go install -tags "" -ldflags "$LD_FLAGS" \
github.com/hyperledger/fabric/cmd/idemixgen

# 编译安装 osnadmin，等价于执行 make osnadmin,v2.2.3版本所需
$ CGO_CFLAGS=" " \
  go install -tags "" -ldflags "$LD_FLAGS" \
  github.com/hyperledger/fabric/cmd/osnadmin
  
# 编译安装ledgerutil，等价于执行 make ledgerutil,v2.5.3版本所需
$ CGO_CFLAGS=" " \
  go install -tags "" -ldflags "$LD_FLAGS" \
  github.com/hyperledger/fabric/cmd/ledgerutil
```

另外，fabric 项目还提供了不少常见的编译命令，可以参考 Makefile 文件，例如编译所有的二进制文件可以使用如下命令：

```sh
$ make native
```

## （七）**安装 Protobuf 支持和 Go 语言相关工具**

Fabric 代码由 Go 语言构建，开发者可以选择安装如下的 Go 语言相关工具，方便开发和调试：

```shell
# 进入GOPATH目录,如果成功，会在GOPATH/bin下生成protoc-gen-go.exe.....文件
$ go get github.com/golang/protobuf/protoc-gen-go
$ go get github.com/maxbrunsfeld/counterfeiter/v6
$ go get github.com/axw/gocov/...
$ go get github.com/AlekSi/gocov-xml
$ go get golang.org/x/tools/cmd/goimports
$ go get golang.org/x/lint/golint
$ go get github.com/estesp/manifest-tool
$ go get github.com/client9/misspell/cmd/misspell
$ go get github.com/onsi/ginkgo/ginkgo
```

注：使用echo $GOPATH来查看自己的gopath路径：

![截屏2023-10-09 16.58.47](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 16.58.47.png)

### 1.go get问题

对我来说，`go get`不知道为什么，就是各种`time out`，尝试了很多方法还是一样。这里说一下，`go get`实际上做了什么事情，首先他通过`git`将源码下载到`$GOPATH/src`中，然后执行`go install`来编译源码，输出可执行文件到`$GOPATH/bin`中，所以`go get`失败的可以尝试去把源码下载下来，然后手动`go install`。
举个例子，安装`maxbrunsfeld/counterfeiter`，这个在搭建`fabric`的时候会用到：看`README.md`的安装说明：
`go get -u github.com/maxbrunsfeld/counterfeiter`，然后执行以下命令，

```shell
$ mkdir -p $GOPATH/src/github.com/maxbrunsfeld
$ cd $GOPATH/src/github.com/maxbrunsfeld
$ git clone https://github.com/maxbrunsfeld/counterfeiter.git
$ go install ./counterfeiter
```

![截屏2023-10-09 22.21.47](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 22.21.47.png)

### 2.golang/tools

这个也是搭建`fabric`会用到

```shell
$ mkdir -p $GOPATH/src/golang.org/x/
$ cd $GOPATH/src/golang.org/x/
$ git clone https://github.com/golang/tools.git
```

这个不需要`go install`

![截屏2023-10-09 22.20.45](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 22.20.45.png)

## （八）Sampleconfig 示例配置

sampleconfig 目录下包括了一些示例配置文件，可以作为参考，包括：

- configtx.yaml：示例配置区块生成文件夹；
- orderer.yaml：示例 Orderer 节点配置文件；
- core.yaml：示例 Peer 节点配置文件；
- msp/config.yaml：示例组织身份配置文件；
- msp：示例证书和秘钥文件。

可以将它们复制到fabric-samples目录下进行使用演示。

## （九）*Docker*容器镜像

除了手动进行本地编译外，还可以采用容器（Docker）镜像的方式快速获取和运行 Fabric 网络，节约本地编译等待的时间。

### 1.**Docker 镜像依赖关系**

Docker 镜像可以自行从源码编译，或通过从 DockerHub 仓库下载等方式。目前，Fabric 项目相关的 Docker 镜像有十几个，这些镜像都在 `hyperledger` 仓库中，它们之间的相互依赖关系如下图所示。

​                                                                    镜像之间的依赖关系

从用途上，可以可以大致分为三类：核心镜像、辅助镜像和第三方镜像。

### 2.**核心镜像**

提供 Fabric 网络运行的核心功能，目前包括 fabric-peer、fabric-orderer、fabric-ca、fabric-baseos、fabric-ccenv、fabric-javaenv、fabric-nodeenv 共 7 种镜像。如下表所示。

| 镜像名称       | 父镜像                                      | 功能描述                                                     |
| -------------- | :------------------------------------------ | ------------------------------------------------------------ |
| fabric-peer    | alpine:3.10                                 | peer 节点镜像，安装了 peer 相关文件。生成过程使用 golang:1.13.4-alpine3.10 镜像。 |
| fabric-orderer | alpine:3.10                                 | orderer 节点镜像，安装了 orderer 相关文件。生成过程使用 golang:1.13.4-alpine3.10 镜像。 |
| fabric-ca      | alpine:3.10                                 | fabric-ca 镜像，安装了 fabric-ca 相关文件。生成过程使用 golang:1.13.4-alpine 镜像。 |
| fabric-baseos  | alpine:3.10                                 | 基础镜像，用来生成其它镜像（包括 Peer、Orderer、fabric-ca），并作为 Go 链码的默认运行时镜像。 |
| fabric-ccenv   | golang:1.13.4-alpine3.10                    | 支持 Go 语言的链码基础镜像，其中安装了 g++、gcc、git、musl-dev 等，并创建 chaincode 存放目录。在链码实例化过程中作为默认编译环境将链码编译为二进制文件。 |
| fabric-javaenv | adoptopenjdk/openjdk11:jdk-11.0.4_11-alpine | 支持 Java 语言的链码基础镜像，其中安装了 Gradle、Maven、Java 链码 shim 层等，作为 Java 链码的默认运行时镜像。 |
| fabric-nodeenv | node:12.13.0-alpine                         | 支持 Node.Js 语言的链码基础镜像，其中安装了 make、python、g++。在链码实例化过程中作为默认编译环境生成 Node.Js 链码镜像，同时作为 Node.Js 链码运行环境。 |

### 3.**辅助镜像**

提供支持功能，目前包括 fabric-baseimage、fabric-tools 镜像。如下表所示。

| 镜像名称         | 父镜像                                   | 功能描述                                                     |
| ---------------- | ---------------------------------------- | ------------------------------------------------------------ |
| fabric-baseimage | adoptopenjdk:8u222-b10-jdk-openj9-0.15.1 | 基础镜像，安装了 wget、Golang、Node.JS、Python、Protocol buffer 支持等，用来生成其它镜像。作为运行时可以用来生成 Node.Js 链码镜像。 |
| fabric-tools     | golang:1.13.4-alpine                     | 安装了 bash、jq、peer、cryptogen、configtxgen 等常见命令，可以作为测试客户端使用。 |

### 4.**第三方镜像**

主要是一些第三方开源软件，提供支持功能，目前包括 coudhdb、kafka、zookeeper 共 3 种镜像。如下表所示。

| 镜像名称         | 父镜像                                   | 功能描述                                                     |
| ---------------- | ---------------------------------------- | ------------------------------------------------------------ |
| fabric-couchdb   | debian:stretch-20190910-slim             | couchdb 镜像，可以启动 couchdb 服务，供 peer 使用。          |
| fabric-kafka     | adoptopenjdk:8u222-b10-jre-openj9-0.15.1 | kafka 镜像，可以启动 kafka 服务，供 orderer 在 kafka 模式下使用。已经不再支持。 |
| fabric-zookeeper | adoptopenjdk:8u222-b10-jre-openj9-0.15.1 | zookeeper 镜像，可以启动 zookeeper 服务，供 orderer 在 kafka 模式下使用。已经不再支持。 |

## （十）源码生成Docker镜像

可以通过如下命令在本地快速生成包括 fabric-baseos、fabric-peer、fabric-orderer、fabric-ccenv、fabric-tools 等多个 Docker 镜像：

```shell
$ make docker
```

注意，从源码直接生成的镜像，除了版本标签外，还会带有所编译版本快照信息的标签，例如 `amd64-2.0.0-snapshot123456`。

### 1.DockerFile常用指令

```dockerfile
FROM			 指明构建的新镜像是来自于哪个基础镜像
MAINTAINER  	 指明镜像维护者及其联系方式（姓名+邮箱）
RUN				 制作镜像需要运行的命令，RUN后面接linux里的命令，这个命令是在制作镜像的时候使用的
WORKDIR			 镜像的工作目录，docker exec 命令执行的时候进入的目录
VOLUME			 向镜像创建的容器中添加数据卷，数据卷可以在容器之间共享和重用
EXPOSE			 指明容器运行的时候暴露的端口
ONBUILD			 当构建一个被继承DockerFile的时候，就会运行ONBUILD指令，触发指令
ENV				 设置镜像环境变量
ADD       		 可以从一个URL地址下载内容复制到容器文件系统中，还可以将压缩包文件解压并复制到指定位置
COPY			 COPY指令用来将本地的文件或者文件夹复制到镜像的指定路径下

# 文件复制均使用 COPY 指令,在需要自动解压缩的场合使用 ADD 指令
CMD				 指定这个容器启动的时候要运行的命令
				 Dockerfile只允许使用一次CMD指令，一般都是脚本中最后一条指令
ENTRYPOINT		 指定这个容器启动的时候要运行的命令，可以追加命令

# 如果docker run后面出现与CMD指定的相同的命令，那么CMD就会被覆盖。而ENTRYPOINT会把容器名后面的所有内容都当成参数传递给其指定的命令
CMD和ENTRYPOINT的区别
```

读者也可自行通过编写 Dockefile 的方式来生成相关镜像。其镜像文件在子目录：

```bash
cd ~/go/src/github.com/hyperledger/fabric/images
ls
```

截图如下：

![截屏2023-10-09 17.05.55](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 17.05.55.png)

Dockerfile 中指令跟本地编译过程十分类似，这里给出 fabric-base 镜像、fabric-orderer 镜像和 fabric-peer 镜像等关键镜像的 Dockerfile，供读者参考使用。

### **2.fabric-base 镜像**

笔者提供的 fabric-base 镜像基于 golang:1.20.8 镜像生成，可以作为 Go 链码容器的基础镜像。该镜像中包含了 Fabric 相关的代码，并安装了一些有用的工具，包括 gotools、 configtxgen、configtxlator、cryptogen、discover、token、idemixgen 等。

该 Dockerfile 内容如下：

```dockerfile
#
# Copyright contributors to the Hyperledger Fabric project
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
# 	  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

ARG GO_VER
ARG UBUNTU_VER

FROM ubuntu:${UBUNTU_VER} as base

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

RUN apt update && apt install -y tzdata

RUN addgroup --gid 500 chaincode
RUN adduser --disabled-password --gecos "" --uid 500 --gid 500 --home /home/chaincode chaincode

USER chaincode
```

该镜像也可以用作替代 `hyperledger/fabric-baseimage:latest` 镜像。

### 3.**fabric-orderer 镜像**

fabric-orderer 镜像基于 fabric-base 生成，编译安装了 orderer 组件。

参考 Dockerfile 内容如下:

```dockerfile
#
# Copyright contributors to the Hyperledger Fabric project
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
# 	  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

###############################################################################
# Build image
###############################################################################

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER} as builder

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

ARG TARGETARCH
ARG TARGETOS
ARG FABRIC_VER
ARG GO_VER
ARG GO_TAGS

RUN apt update && apt install -y \
    git \
    gcc \
    curl \
    make

RUN curl -sL https://golang.google.cn/dl/go${GO_VER}.${TARGETOS}-${TARGETARCH}.tar.gz | tar zxf - -C /usr/local
ENV PATH="/usr/local/go/bin:$PATH"

ADD . .

RUN make orderer GO_TAGS=${GO_TAGS} FABRIC_VER=${FABRIC_VER}


###############################################################################
# Runtime image
###############################################################################

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER}

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

ARG FABRIC_VER

# set up nsswitch.conf for Go's "netgo" implementation
# - https://github.com/golang/go/blob/go1.9.1/src/net/conf.go#L194-L275
# - docker run --rm debian:stretch grep '^hosts:' /etc/nsswitch.conf
RUN echo 'hosts: files dns' > /etc/nsswitch.conf

ENV FABRIC_CFG_PATH /var/hyperledger/fabric/config
ENV FABRIC_VER      ${FABRIC_VER}

COPY --from=builder  build/bin/orderer           /usr/local/bin
COPY --from=builder  sampleconfig/msp            ${FABRIC_CFG_PATH}/msp
COPY --from=builder  sampleconfig/orderer.yaml   ${FABRIC_CFG_PATH}
COPY --from=builder  sampleconfig/configtx.yaml  ${FABRIC_CFG_PATH}

VOLUME /etc/hyperledger/fabric
VOLUME /var/hyperledger

EXPOSE 7050

CMD ["orderer", "start" ]
```

### **4.fabric-peer 镜像**

fabric-peer 镜像基于 fabric-base 生成，编译安装了 peer 命令。

Dockerfile 内容如下:

```dockerfile
#
# Copyright contributors to the Hyperledger Fabric project
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
# 	  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

###############################################################################
# Build image
###############################################################################

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER} as builder

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

ARG TARGETARCH
ARG TARGETOS
ARG FABRIC_VER
ARG GO_VER
ARG GO_TAGS

RUN apt update && apt install -y \
    git \
    gcc \
    curl \
    make

RUN curl -sL https://golang.google.cn/dl/go${GO_VER}.${TARGETOS}-${TARGETARCH}.tar.gz | tar zxf - -C /usr/local
ENV PATH="/usr/local/go/bin:$PATH"

ADD . .

RUN make peer GO_TAGS=${GO_TAGS} FABRIC_VER=${FABRIC_VER}
RUN make ccaasbuilder


###############################################################################
# Runtime image
###############################################################################

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER}

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

ARG TARGETOS
ARG TARGETARCH
ARG FABRIC_VER

# set up nsswitch.conf for Go's "netgo" implementation
# - https://github.com/golang/go/blob/go1.9.1/src/net/conf.go#L194-L275
# - docker run --rm debian:stretch grep '^hosts:' /etc/nsswitch.conf
RUN echo 'hosts: files dns' > /etc/nsswitch.conf

ENV FABRIC_CFG_PATH /var/hyperledger/fabric/config
ENV FABRIC_VER ${FABRIC_VER}

COPY --from=builder build/bin/peer /usr/local/bin
COPY --from=builder sampleconfig/msp ${FABRIC_CFG_PATH}/msp
COPY --from=builder sampleconfig/core.yaml ${FABRIC_CFG_PATH}/core.yaml

COPY --from=builder release/${TARGETOS}-${TARGETARCH}/builders/ccaas/bin /opt/hyperledger/ccaas_builder/bin

VOLUME /etc/hyperledger/fabric
VOLUME /var/hyperledger

EXPOSE  7051
CMD [ "peer","node","start" ]
```

编译信息：

```
Building Docker image hyperledger/fabric-peer
docker build --force-rm  -f images/peer/Dockerfile \
        --build-arg GO_VER=1.20.8 \
        --build-arg UBUNTU_VER=22.04 \
        --build-arg FABRIC_VER=2.5.3 \
        --build-arg TARGETARCH=amd64 \
        --build-arg TARGETOS=linux \
        --build-arg GO_TAGS= \
        -t hyperledger/fabric-peer ./
[+] Building 58.6s (12/16)                                                                                                                                                                docker:default
 => [internal] load build definition from Dockerfile                                                                                                                                                0.0s
 => => transferring dockerfile: 2.49kB                                                                                                                                                              0.0s
 => [internal] load .dockerignore                                                                                                                                                                   0.0s
 => => transferring context: 277B                                                                                                                                                                   0.0s
 => [internal] load metadata for docker.io/library/ubuntu:22.04                                                                                                                                    15.2s
 => [builder 1/7] FROM docker.io/library/ubuntu:22.04@sha256:f154feaf13b51d16e2b4b5575d69abc808da40c4b80e3a5055aaa4bcc5099d5b                                                                       0.0s
 => [internal] load build context                                                                                                                                                                   0.5s
 => => transferring context: 422.57kB                                                                                                                                                               0.5s
 => CACHED [builder 2/7] RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list                                                                                               0.0s
 => CACHED [stage-1 3/7] RUN echo 'hosts: files dns' > /etc/nsswitch.conf                                                                                                                           0.0s
 => CACHED [builder 3/7] RUN apt update && apt install -y     git     gcc     curl     make                                                                                                         0.0s
 => CACHED [builder 4/7] RUN curl -sL https://golang.google.cn/dl/go1.20.8.linux-amd64.tar.gz | tar zxf - -C /usr/local                                                                             0.0s
 => CACHED [builder 5/7] ADD . .                                                                                                                                                                    0.0s
 => CACHED [builder 6/7] RUN make peer GO_TAGS= FABRIC_VER=2.5.3                                                                                                                                    0.0s
 => ERROR [builder 7/7] RUN make ccaasbuilder          
```

### **5.fabric-ccenv 镜像**

```dockerfile
#
# Copyright contributors to the Hyperledger Fabric project
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
# 	  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER}

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

ARG TARGETARCH
ARG TARGETOS
ARG GO_VER

RUN apt update && apt install -y \
    binutils-gold \
    curl \
    g++ \
    gcc \
    git

RUN curl -sL https://golang.google.cn/dl/go${GO_VER}.${TARGETOS}-${TARGETARCH}.tar.gz | tar zxvf - -C /usr/local
ENV PATH="/usr/local/go/bin:$PATH"

RUN addgroup --gid 500 chaincode
RUN adduser  --disabled-password --gecos "" --uid 500 --gid 500 --home /home/chaincode chaincode

RUN mkdir    -p /chaincode/output /chaincode/input
RUN chown    -R chaincode:chaincode /chaincode

USER chaincode
```

### 6.**fabric-tools镜像**

```dockerfile
#
# Copyright contributors to the Hyperledger Fabric project
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
# 	  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

###############################################################################
# Build image
###############################################################################

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER} as builder

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

ARG TARGETARCH
ARG TARGETOS
ARG FABRIC_VER
ARG GO_VER
ARG GO_TAGS

RUN apt update && apt install -y \
    git \
    gcc \
    curl \
    make

RUN curl -sL https://golang.google.cn/dl/go${GO_VER}.${TARGETOS}-${TARGETARCH}.tar.gz | tar zxf - -C /usr/local
ENV PATH="/usr/local/go/bin:$PATH"

ADD . .

RUN make tools GO_TAGS=${GO_TAGS} FABRIC_VER=${FABRIC_VER}


###############################################################################
# Runtime image
###############################################################################

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER}

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

ARG TARGETARCH
ARG TARGETOS
ARG FABRIC_VER
ARG GO_VER

RUN apt update && apt install -y \
    bash \
    curl \
    jq \
    tzdata

RUN curl -sL https://golang.google.cn/dl/go${GO_VER}.${TARGETOS}-${TARGETARCH}.tar.gz | tar zxvf - -C /usr/local
ENV PATH="/usr/local/go/bin:$PATH"

# set up nsswitch.conf for Go's "netgo" implementation
# - https://github.com/golang/go/blob/go1.9.1/src/net/conf.go#L194-L275
# - docker run --rm debian:stretch grep '^hosts:' /etc/nsswitch.conf
RUN echo 'hosts: files dns' > /etc/nsswitch.conf

ENV FABRIC_CFG_PATH /var/hyperledger/fabric/config
ENV FABRIC_VER      ${FABRIC_VER}

COPY --from=builder  sampleconfig    ${FABRIC_CFG_PATH}
COPY --from=builder  build/bin       /usr/local/bin

VOLUME  /etc/hyperledger/fabric
VOLUME  /var/hyperledger
```

### 7.**fabric-ca 镜像**

fabric-ca 镜像基于 golang:1.20镜像生成，提供对证书的签发功能。

Dockerfile 内容如下:

```dockerfile
#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

###############################################################################
# Build image
###############################################################################

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER} as builder

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

ARG TARGETARCH
ARG TARGETOS
ARG GO_VER
ARG GO_LDFLAGS
ARG GO_TAGS

RUN apt update && apt install -y \
    gcc \
    binutils-gold \
    git \
    curl \
    make

RUN curl -sL https://golang.google.cn/dl/go${GO_VER}.${TARGETOS}-${TARGETARCH}.tar.gz | tar zxf - -C /usr/local
ENV GOBIN="/usr/local/go/bin"
ENV PATH="$GOBIN:$PATH"

ADD . /build/fabric-ca
WORKDIR /build/fabric-ca

RUN go install \
    -tags "${GO_TAGS}" \
    -ldflags "${GO_LDFLAGS}" \
    github.com/hyperledger/fabric-ca/cmd/fabric-ca-server

RUN go install \
    -tags "${GO_TAGS}" \
    -ldflags "${GO_LDFLAGS}" \
    github.com/hyperledger/fabric-ca/cmd/fabric-ca-client


###############################################################################
# Runtime image
###############################################################################

ARG UBUNTU_VER
FROM ubuntu:${UBUNTU_VER}

RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

RUN apt update
RUN DEBIAN_FRONTEND=noninteractive apt install -y tzdata

ENV FABRIC_CA_HOME /etc/hyperledger/fabric-ca-server
COPY --from=builder /usr/local/go/bin /usr/local/bin

EXPOSE 7054

CMD [ "fabric-ca-server", "start", "-b", "admin:adminpw" ]
```

## （十一）Dockerhub 获取镜像

除了从源码编译外，还可以直接从 Dockerhub 来拉取相关的镜像，命令格式为 `docker pull <IMAGE_NAME:TAG>`。

从社区仓库直接获取 fabric-peer、fabric-orderer、fabric-ca、fabric-tools 等镜像的版本可以使用如下命令：

```shell
$ PROJECT_VERSION=2.5

# 拉取镜像
$ docker pull hyperledger/fabric-peer:$PROJECT_VERSION
$ docker pull hyperledger/fabric-orderer:$PROJECT_VERSION

$ docker pull hyperledger/fabric-tools:$PROJECT_VERSION
$ docker pull hyperledger/fabric-ccenv:$PROJECT_VERSION
$ docker pull hyperledger/fabric-baseos:$PROJECT_VERSION

$ CA_VERSION=1.5.7
$ docker pull hyperledger/fabric-ca:$CA_VERSION
```

# 三、*Hyperledger Fabric*测试网络（*test-network*）官方教程

## （一）Getting Started

在运行测试网络之前，您需要在 环境。按照[getting_started](https://hyperledger-fabric.readthedocs.io/en/release-2.5/getting_started.html)上的说明安装所需的软件。

**注意：**测试网络已成功通过 Docker 桌面版本 2.5.0.1 验证，是目前推荐的版本。更高版本可能无法正常工作。

## （二）启动测试网络

可以在目录中找到用于启动网络的脚本 存储库。通过以下方式导航到测试网络目录 使用以下命令：`test-network``fabric-samples`

```bash
cd fabric-samples/test-network
```

在此目录中，您可以找到一个带注释的脚本 ，该脚本位于 使用本地计算机上的 Docker 映像连接到结构网络。您可以运行以打印脚本帮助文本：`network.sh``./network.sh -h`

在目录中，运行以下命令以删除 以前运行的任何容器或项目：`test-network`

```bash
./network.sh down
```

然后，您可以通过发出以下命令来启动网络。你会 尝试从另一个目录运行脚本时遇到问题：

```bash
./network.sh up
```

此命令创建一个由两个对等节点组成的结构网络，一个 排序节点。运行时不会创建通道，尽管我们 将在[以后的步骤](https://hyperledger-fabric.readthedocs.io/en/release-2.5/test_network.html#creating-a-channel)中到达那里。如果命令完成 成功，您将看到正在创建的节点的日志：`./network.sh up`

如果未得到此结果，请跳转到[疑难解答](https://hyperledger-fabric.readthedocs.io/en/release-2.5/test_network.html#troubleshooting)，以获取有关可能出错的帮助。默认情况下，网络使用 加密工具，以启动网络。但是，您也可以[使用证书颁发机构启动网络](https://hyperledger-fabric.readthedocs.io/en/release-2.5/test_network.html#bring-up-the-network-with-certificate-authorities)。

## （三）测试网络的组成部分

部署测试网络后，可以花一些时间来检查其 组件。运行以下命令以列出所有 Docker 容器 正在您的计算机上运行。您应该看到由 脚本：`network.sh`

```bash
docker ps -a
```

![截屏2023-10-10 07.48.25](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 07.48.25.png)

与结构网络交互的每个节点和用户都需要属于 组织，以便参与网络。测试内容 网络包括两个对等组织，即组织 1 和组织 2。它还包括一个 维护网络排序服务的排序者组织。

[对等体](https://hyperledger-fabric.readthedocs.io/en/release-2.5/peers/peers.html)是任何结构网络的基本组件。 对等节点存储区块链分类账并在交易之前验证交易 提交到账本。对等方运行包含业务的智能合约 用于管理区块链账本上的资产的逻辑。

网络中的每个对等方都需要属于一个组织。在 测试网络，每个组织各自运行一个对等点，以及 .`peer0.org1.example.com``peer0.org2.example.com`

每个结构网络还包括一个[订购服务](https://hyperledger-fabric.readthedocs.io/en/release-2.5/orderer/ordering_service.html)。 当对等方验证事务并将事务块添加到 区块链分类账，他们不决定交易顺序或包括 他们进入新的块。在分布式网络上，对等方可能跑得很远 彼此之间，并且对事务的创建时间没有共同的视图。 就交易顺序达成共识是一个代价高昂的过程，它将 为对等方创建开销。

排序服务允许对等方专注于验证交易和 将它们提交到账本。排序节点收到背书交易后 从客户那里，他们就交易顺序达成共识，然后添加 他们到块。然后将块分发到对等节点，这些节点添加 区块链分类账的块。

示例网络使用由 排序者组织。您可以看到计算机上运行的排序节点 如。而测试网络仅使用单节点排序 服务，一个生产网络将有多个排序节点，由一个或 多个订购者组织。不同的排序节点将使用 Raft 共识算法就交易顺序达成一致 网络。`orderer.example.com`

## （四）创建通道

现在我们的机器上运行了对等节点和排序节点，我们可以使用 脚本，用于为 Org1 和 Org2 之间的事务创建结构通道。 通道是特定网络成员之间的专用通信层。 频道只能由受邀加入频道的组织使用，并且 对网络的其他成员不可见。每个通道都有一个单独的 区块链分类账。受邀“加入”其同行的组织 用于存储通道账本并验证交易的通道 渠道。

您可以使用该脚本在 Org1 和 Org2 之间创建通道 并将他们的同行加入频道。运行以下命令以创建一个 默认名称为 mychannel的通道：

```bash
./network.sh createChannel
```

## （五）与网络交互

见实践过程

## （六）关闭网络

使用完测试网络后，可以关闭网络 使用以下命令：

```bash
./network.sh down
```

该命令将停止并删除节点和链码容器，删除 组织加密材料，并从您的 Docker 中删除链码映像 注册表。该命令还会从中删除通道项目和 docker 卷 以前的运行，允许您在遇到时再次运行 任何问题。`./network.sh up`

# 四、*Hyperledger Fabric*测试网络（*test-network*）实践

## （一）fabric-sample下载

```shell
$ cd ~/go/src/github.com/hyperledger
$ git clone https://github.com/hyperledger/fabric-samples.git
$ cd fabric-samples
$ git checkout -b v2.5.3
```

![截屏2023-10-09 20.46.42](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 20.46.42.png)

![截屏2023-10-09 20.48.11](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 20.48.11.png)

## （二）移动*config*文件夹（移动配置文件）

（1）进入*fabric*文件夹，会发现*sampleconfig*，其实就是*fabric-samples*的*config*文件夹

（2）将*sampleconfig*文件夹移动到*fabric-samples*中，并且重命名为*config*

```shell
$ cd ~/go/src/github.com/hyperledger/fabric
$ cp -r sampleconfig ~/go/src/github.com/hyperledger/fabric-samples
$ cd ~/go/src/github.com/hyperledger/fabric-samples
$ mv sampleconfig config
```

![截屏2023-10-09 20.51.20](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 20.51.20.png)

## （三）创建并初始化*Fabric*网络

输入如下指令创建并初始化Fabric网络：

```bash
$ cd ~/go/src/github.com/hyperledger/fabric-samples/test-network
$ ./network.sh up -ca
$ ./network.sh createChannel
$ ./network.sh deployCC -ccn basic -ccp ../asset-transfer-basic/chaincode-go -ccl go
```

## （四）账本交互

### 1.交互环境配置

以Org1的Peer0的身份进行账本交互，在命令行中输入以下指令

```bash
export PATH=${PWD}/../bin:${PWD}:$PATH
export FABRIC_CFG_PATH=$PWD/../config/

export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_LOCALMSPID="Org1MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
export CORE_PEER_ADDRESS=localhost:7051
```

![截屏2023-10-10 08.43.13](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 08.43.13.png)

### 2.创建资产

```bash
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n basic --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt -c '{"function":"CreateAsset","Args":["asset6","black","20","Jack","630"]}'
```

![截屏2023-10-10 08.44.37](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 08.44.37.png)

### 3.查询创建的资产

```bash
peer chaincode query -C mychannel -n basic -c '{"Args":["ReadAsset","asset6"]}'
```

### 4.更新资产

将颜色改为blue蓝色，价值改为680

```bash
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n basic --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt -c '{"function":"UpdateAsset","Args":["asset6","blue","20","Jack","680"]}'
```


查询资产是否更新成功

```bash
peer chaincode query -C mychannel -n basic -c '{"Args":["ReadAsset","asset6"]}'
```

![截屏2023-10-10 08.45.16](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 08.45.16.png)

### 5.查询资产是否存在

```bash
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n basic --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt -c '{"function":"AssetExists","Args":["asset6"]}'
```

![截屏2023-10-10 08.45.35](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 08.45.35.png)

### 6.资产转移

将asset6资产由Jack转给Michel：

```bash
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n basic --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt -c '{"function":"TransferAsset","Args":["asset6","Michel"]}'
```

![截屏2023-10-10 08.45.53](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 08.45.53.png)

### 7 删除资产

将asset6资产删除

```bash
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n basic --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt -c '{"function":"DeleteAsset","Args":["asset6"]}'
```

![截屏2023-10-10 08.46.11](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 08.46.11.png)

# 五、报错及解决方案

**（一）项目无法上传到gitee**

使用git push命令时报错：

![截屏2023-10-08 09.37.08](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 09.37.08.png)

**解决方案：**参考gitee的官方教程

```terminal
mkdir gin-gonic
cd gin-gonic
git init 
touch README.md
git add README.md
git commit -m "first commit"
git remote add origin https://gitee.com/cryang03/gin-gonic.git
git push -u origin "master"
```

![截屏2023-10-08 09.43.16](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 09.43.16.png)

**（二）本地项目无法上传至仓库**

将之前已经做了的本地仓库上传至仓库时报错，操作步骤如下：

```terminal
1、git init 初始化
2、git add .  将当前目录下修改的所有代码从工作区添加到暂存区
3、git commit -m  ['注释']  将缓存区内容添加到本地仓库
4、git remote add origin 仓库地址  将本地仓库与远程仓库连接起来
5、git push origin master 将项目推送到远程仓库的master分支上
```

![截屏2023-10-08 10.10.22](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-08 10.10.22.png)

**解决方案：**出现错误的主要原因是gitee中的README.md文件不在本地代码目录中

此时我们要执行**git pull --rebase origin master**命令将README.md拉到本地，

然后执行git push origin master就可以成功了

**（三）unable to access 'https://github.com/hyperledger/fabric.git/': GnuTLS recv error (-110): The TLS connection was non-properly terminated.**

在获取Fabric源码的过程中，出现报错：

![截屏2023-10-09 10.17.02](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.17.02.png)

**解决方案：**在终端中执行如下命令：

```shell
git config --global --unset http.proxy 
git config --global --unset https.proxy
```

**（四）fatal: not a git repository (or any of the parent directories): .git**

![截屏2023-10-09 10.38.09](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.38.09.png)

**解决方案：**

```shell
git init
git status
git checkout -b v1.5.7
```

![截屏2023-10-09 10.40.26](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 10.40.26.png)

**（五）Local fabric binaries and docker images are out of sync. This may cause problems.**

初始化fabric网络时报错：

![截屏2023-10-09 21.01.40](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 21.01.40.png)

**解决方案：**原因是fabric二进制文件和镜像版本不一致，首先查看两者的版本（fabric的最新版本是2.5.0）：

```shell
peer version
docker run --rm hyperledger/fabric-tools:latest peer version | sed -ne 's/ Version: //p' | head -1
```

![截屏2023-10-09 22.35.00](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 22.35.00.png)因此只要我们的镜像版本随本地一致即可：

```shell
docker images | grep -E "(hyperledger)" | awk '{print $3}' | uniq | xargs -I {} docker rmi --force {} #删除fabric镜像
cd /go/src/github.com/hyperledger/fabric/scripts/
sudo vim bootstrap.sh
```

![截屏2023-10-09 22.36.38](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 22.36.38.png)

保存后执行./bootstrap.sh重新运行：

![截屏2023-10-09 22.37.11](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-09 22.37.11.png)

或是直接使用pull命令：

```shell
docker pull hyperledger/fabric-tools:2.5.3
docker tag hyperledger/fabric-tools:2.5.3 hyperledger/fabric-tools #修改标签
```

![截屏2023-10-10 08.17.31](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 08.17.31.png)

![截屏2023-10-10 08.17.43](/Users/yangchaoran/Library/Application Support/typora-user-images/截屏2023-10-10 08.17.43.png)

# 六、实验心得

在本周的学习过程中，我有幸深入了解了Gitee、Hyperledger Fabric本地编译以及Hyperledger Fabric测试网络（test-network）。这些学习内容既包括理论概念，也包括实践操作，让我收获颇丰。

在学习Gitee的过程中，我体验到了版本控制系统的魅力。Gitee作为一款国产的代码托管平台，其用户界面友好，使用起来非常便捷。我尝试了创建项目、上传代码、以及参与他人的项目，亲身体验到了Gitee的强大功能。与Git相比，Gitee在某些功能上有着更好的用户体验，例如拉取代码时可以选择性下载最近的历史版本，这大大节省了我们的时间和精力。

在研究Hyperledger Fabric本地编译的过程中，我对区块链技术有了更深入的理解。通过编译和运行代码，我学习了如何创建智能合约，如何定义交易和查询，以及如何实现链码的状态管理等。尽管编译过程遇到了一些困难，但我还是坚持下来，成功地构建了本地测试网络。这个过程中，我更加深刻地认识到区块链技术的复杂性和魅力。

创建Hyperledger Fabric测试网络（test-network）的过程对我来说有些复杂。我花了大量时间阅读文档，试图理解每一步操作的目的和原理。在搭建网络的过程中，我遇到了很多问题，比如如何配置节点，如何处理交易冲突等。尽管感到压力，但我还是通过查找资料、请教他人以及自己的摸索，逐渐解决了这些问题。这个过程虽然充满挑战，但却让我收获了很多宝贵的经验和教训。

回顾本周的学习过程，我深感自己还有许多不足。首先，我在解决一些技术问题时过于依赖他人，没有主动去寻找解决方案。其次，我在学习过程中缺乏系统性的规划，导致有些知识点没有掌握扎实。为了改进这些不足，我将在未来的学习中更加积极主动，培养自己独立解决问题的能力。

总之，本周的学习让我收获颇丰。通过实际操作，我深入了解了Gitee、Hyperledger Fabric本地编译以及Hyperledger Fabric测试网络（test-network）等重要知识点。这些学习内容不仅提升了我的专业技能，也拓宽了我的视野。在未来的学习和工作中，我将更加注重独立思考和解决问题的能力，努力将这些宝贵的经验应用到实践中。同时，我会持续关注这些领域的最新动态，以便不断更新自己的知识体系。

在学习过程中，我深刻体会到技术发展的迅速与不易。每一个新的技术概念都需要我们不断学习和实践，才能真正掌握其精髓。因此，我将保持谦逊和开放的心态，不断追求新知识，以适应日新月异的技术变革。

总之，本周的学习经历是我人生中一段宝贵的时光，我会永远珍藏这段回忆。感谢这个学习过程给我带来的成长与启示，让我更有信心面对未来的挑战。我期待着将这些所学应用到未来的学习和工作中，为推动技术的发展做出自己的贡献。
